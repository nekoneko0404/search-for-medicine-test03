import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */function P(t){if(!t||t.querySelector(".chart-loading-overlay"))return;const e=document.createElement("div");e.className="chart-loading-overlay",e.innerHTML='<div class="chart-loading-skeleton"></div>',window.getComputedStyle(t).position==="static"&&t.classList.add("position-relative"),t.appendChild(e)}function b(t){if(!t)return;const e=t.querySelector(".chart-loading-overlay");e&&e.remove()}console.log("infection app main.js loaded");const G="https://script.google.com/macros/s/AKfycby8wh0NMuPtEOgLVHXfc0jzNqlOENuOgCwQmYYzMSZCKTvhSDiJpZkAyJxntGISTGOmbQ/exec";let l={current:null,archives:[]},A="Influenza";const $=window.getDiseaseName=function(t){return{Influenza:"インフルエンザ","COVID-19":"COVID-19",ARI:"急性呼吸器感染症 (ARI)",RSV:"ＲＳウイルス感染症",PharyngoconjunctivalFever:"咽頭結膜熱",AGS_Pharyngitis:"Ａ群溶血性レンサ球菌咽頭炎",InfectiousGastroenteritis:"感染性胃腸炎",Chickenpox:"水痘",HandFootMouthDisease:"手足口病",ErythemaInfectiosum:"伝染性紅斑",ExanthemSubitum:"突発性発しん",Herpangina:"ヘルパンギーナ",Mumps:"流行性耳下腺炎",AcuteHemorrhagicConjunctivitis:"急性出血性結膜炎",EpidemicKeratoconjunctivitis:"流行性角結膜炎",BacterialMeningitis:"細菌性髄膜炎",AsepticMeningitis:"無菌性髄膜炎",MycoplasmaPneumonia:"マイコプラズマ肺炎",ChlamydiaPneumonia:"クラミジア肺炎",RotavirusGastroenteritis:"感染性胃腸炎（ロタウイルス）"}[t]||t},q=[{key:"Influenza",name:"インフルエンザ"},{key:"COVID-19",name:"COVID-19"},{key:"ARI",name:"急性呼吸器感染症"},{key:"RSV",name:"ＲＳウイルス感染症"},{key:"PharyngoconjunctivalFever",name:"咽頭結膜熱"},{key:"AGS_Pharyngitis",name:"Ａ群溶血性レンサ球菌咽頭炎"},{key:"InfectiousGastroenteritis",name:"感染性胃腸炎"},{key:"Chickenpox",name:"水痘"},{key:"HandFootMouthDisease",name:"手足口病"},{key:"ErythemaInfectiosum",name:"伝染性紅斑"},{key:"ExanthemSubitum",name:"突発性発しん"},{key:"Herpangina",name:"ヘルパンギーナ"},{key:"Mumps",name:"流行性耳下腺炎"},{key:"AcuteHemorrhagicConjunctivitis",name:"急性出血性結膜炎"},{key:"EpidemicKeratoconjunctivitis",name:"流行性角結膜炎"},{key:"BacterialMeningitis",name:"細菌性髄膜炎"},{key:"AsepticMeningitis",name:"無菌性髄膜炎"},{key:"MycoplasmaPneumonia",name:"マイコプラズマ肺炎"},{key:"ChlamydiaPneumonia",name:"クラミジア肺炎"},{key:"RotavirusGastroenteritis",name:"感染性胃腸炎（ロタウイルス）"}];let D=null,f=null;window.setCurrentRegion=function(t){D=t,f=null,console.log(`Region selected: ${t}`)};const k={CURRENT_DATA_KEY:"infection_surveillance_current_data_v1",ARCHIVE_DATA_KEY:"infection_surveillance_archive_data_v1",MAIN_EXPIRY:3600*1e3,HISTORY_EXPIRY:1440*60*1e3};async function Z(){const t=Date.now();try{const e=await localforage.getItem(k.CURRENT_DATA_KEY);if(e&&t-e.timestamp<k.MAIN_EXPIRY)return e.data}catch(e){console.warn("Current data cache check failed:",e)}try{const e=await fetch(`${G}?type=current`,{redirect:"follow"});if(!e.ok)throw new Error(`HTTP Error: ${e.status} ${e.statusText}`);const n=await e.json();if(n&&n.status==="error")throw new Error(`API Error: ${n.message}`);try{await localforage.setItem(k.CURRENT_DATA_KEY,{timestamp:t,data:n})}catch(o){console.warn("Current data cache save failed:",o)}return n}catch(e){throw console.error("Fetch error for current data:",e),e}}async function K(){const t=Date.now();try{const e=await localforage.getItem(k.ARCHIVE_DATA_KEY);if(e&&t-e.timestamp<k.HISTORY_EXPIRY)return e.data}catch(e){console.warn("Archive data cache check failed:",e)}try{const e=await fetch(`${G}?type=history`,{redirect:"follow"});if(!e.ok)throw new Error(`HTTP Error: ${e.status} ${e.statusText}`);const n=await e.json();try{await localforage.setItem(k.ARCHIVE_DATA_KEY,{timestamp:t,data:n})}catch(o){console.warn("Archive data cache save failed:",o)}return n}catch(e){throw console.error("Fetch error for archive data:",e),e}}function Q(t){const e=document.getElementById("summary-cards");if(!e)return;for(;e.firstChild;)e.removeChild(e.firstChild);q.filter(o=>["Influenza","COVID-19","ARI"].includes(o.key)).forEach(o=>{const u=o.key,i=t.current.data.find(d=>d.disease===u&&d.prefecture==="全国"),a=t.current.summary.alerts.find(d=>d.disease===u),c=document.createElement("div");c.className=`card ${A===u?"active":""}`,c.dataset.disease=u,c.dataset.status=a?a.level:"normal",c.onclick=()=>ee(u);const m=document.createElement("h4");m.textContent=$(u),c.appendChild(m);const s=document.createElement("p");s.className="value",s.textContent=`${i?i.value.toFixed(2):"-"}`;const h=document.createElement("span");h.className="unit",h.textContent=" 定点当たり",s.appendChild(h),c.appendChild(s);const r=document.createElement("p");r.className=`status ${a?a.level:"normal"}`,r.textContent=a?a.message:"データなし",c.appendChild(r),e.appendChild(c)})}window.switchDisease=function(t){A=t,document.querySelectorAll(".summary-cards .card").forEach(o=>{o.classList.toggle("active",o.dataset.disease===t)});const e=document.getElementById("other-diseases-list-view");if(e&&!e.classList.contains("hidden")?V(f||"全国"):f?F(f,t):Y("main-view"),!f)D&&typeof window.updateDetailPanel=="function"&&l?window.updateDetailPanel(D,l,t,f):T();else if(typeof window.getRegionIdByPrefecture=="function"&&typeof window.updateDetailPanel=="function"&&l){const o=window.getRegionIdByPrefecture(f);o?window.updateDetailPanel(o,l,t,f):T()}else T();l&&U(t,l)};function ee(t){window.switchDisease(t)}let R=null;function O(t){let e=0;return l.current&&l.current.history&&l.current.history.forEach(n=>{n.disease===t&&n.history.forEach(o=>{o.value>e&&(e=o.value)})}),l.archives&&l.archives.forEach(n=>{n.data&&n.data.forEach(o=>{o.disease===t&&o.history.forEach(u=>{u.value>e&&(e=u.value)})})}),e}function z(t,e,n,o,u=null,i){i&&P(i);const a=document.getElementById(t);if(!a){console.warn(`Canvas element with ID '${t}' not found.`),i&&(b(i),i.innerHTML='<p class="no-data-message">グラフを描画できませんでした。</p>');return}const c=a.getContext("2d");a.chart&&a.chart.destroy(),c&&c.clearRect(0,0,a.width,a.height);const m=window.innerWidth<=768,s=Array.from({length:53},(g,v)=>`${v+1}週`),h=g=>{const v=g.year;let C,x,B=1;if(v===new Date().getFullYear()){const y=g.data.filter(p=>p&&p.value!==null&&p.value!==void 0),E=y.length>0?y[y.length-1]:{value:0};C=getColorForValue(E.value,e),x=3,B=2.5}else v===new Date().getFullYear()-1?(C="#A9CCE3",x=2):(C="#E0E0E0",x=1);t.startsWith("chart-")&&(B=0);const w={label:`${v}年`,data:s.map(y=>{const E=parseInt(y),p=g.data.find(M=>M.week===E);return p?p.value:null}),borderColor:C,borderWidth:x,pointRadius:B,fill:!1,tension:.1,spanGaps:!0,_originalColor:C,_originalBorderWidth:x,disease:e,year:v};return v===new Date().getFullYear()&&(w.segment={borderColor:y=>{if(!y.p1||!y.p1.parsed)return C;const E=y.p1.parsed.y;return typeof getColorForValue=="function"?getColorForValue(E,e):C}},w.pointBackgroundColor=y=>{const E=y.parsed.y;return typeof getColorForValue=="function"?getColorForValue(E,e):C},w.pointBorderColor=y=>{const E=y.parsed.y;return typeof getColorForValue=="function"?getColorForValue(E,e):C}),w};new Date().getFullYear();const d=o.sort((g,v)=>v.year-g.year).map(h),I={type:"line",data:{labels:s,datasets:d},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,title:{display:!0,text:"定点当たり報告数"},suggestedMax:u},x:{title:{display:!0,text:"週"},ticks:{maxRotation:0,autoSkip:!0,autoSkipPadding:10}}},interaction:{intersect:!1,mode:"index",axis:"x"},elements:{point:{hitRadius:20,hoverRadius:4},line:{borderCapStyle:"round",borderJoinStyle:"round"}},plugins:{title:{display:!1,text:`${n} ${$(e)} 週次推移`,font:{size:16,family:"'Noto Sans JP', sans-serif"}},tooltip:{enabled:!m,mode:"index",intersect:!1,position:"nearest",bodyFont:{size:m?14:13},titleFont:{size:m?14:13},padding:10,boxPadding:4,backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#fff",bodyColor:"#fff",footerColor:"#fff"},legend:{display:!0,position:"bottom",labels:{boxWidth:10,padding:10,font:{size:m?11:12},usePointStyle:!0,pointStyle:"rectRounded"},onClick:function(g,v,C){g.native&&g.native.stopPropagation();const x=v.datasetIndex,B=C.chart,_=B.data.datasets,w=_[x];w._originalColor||(w._originalColor=w.borderColor,w._originalBorderWidth=w.borderWidth);const y=w.borderColor===w._originalColor,E=_.some((p,M)=>M!==x&&p.borderColor==="rgba(200, 200, 200, 0.2)");y&&E?_.forEach(p=>{p.borderColor=p._originalColor,p.borderWidth=p._originalBorderWidth}):_.forEach((p,M)=>{M!==x?(p.borderColor="rgba(200, 200, 200, 0.2)",p.borderWidth=1):(p.borderColor=p._originalColor,p.borderWidth=3)}),B.update()}}},animation:{duration:0}}},L=()=>{a.chart&&a.chart.destroy(),a.chart=new Chart(c,I),i&&b(i)},N=i||a.parentElement;if(N&&typeof ResizeObserver<"u"){const g=new ResizeObserver(v=>{const C=v[0];C.contentRect.width>0&&C.contentRect.height>0&&(g.disconnect(),L())});g.observe(N)}else setTimeout(L,50)}function U(t,e){const n=document.getElementById("chart-view");n&&P(n),te(t,e.current),n&&b(n),typeof renderJapanMap=="function"&&document.getElementById("japan-map")&&requestAnimationFrame(()=>{renderJapanMap("japan-map",e.current,t)})}function te(t,e){const n=document.getElementById("chart-view");if(!n)return;for(P(n);n.firstChild;)n.removeChild(n.firstChild);const o=document.createElement("canvas");o.id="trendChart",n.appendChild(o);const u=o.getContext("2d");R&&R.destroy();const i=e.data.filter(s=>s.disease===t&&s.prefecture!=="全国").sort((s,h)=>h.value-s.value).slice(0,10),a=i.map(s=>s.prefecture),c=i.map(s=>s.value),m=c.map(s=>typeof getColorForValue=="function"?getColorForValue(s,t):"#3498db");if(a.length===0){b(n);const s=document.createElement("p");s.className="no-data-message",s.textContent="データがありません。",n.appendChild(s);return}R=new Chart(u,{type:"bar",data:{labels:a,datasets:[{label:"定点当たり報告数",data:c,backgroundColor:m,borderColor:m,borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:`${$(t)} 都道府県別 報告数 Top 10`,font:{size:14,family:"'Noto Sans JP', sans-serif"}}},scales:{x:{beginAtZero:!0,title:{display:!0,text:"定点当たり報告数"}},y:{ticks:{autoSkip:!1}}}}}),b(n)}function J(t,e){const n=[],o=new Date().getFullYear(),u=new Set;if(l.current&&l.current.history){const i=l.current.history.find(a=>a.disease===t&&a.prefecture===e);i&&(n.push({year:o,data:i.history}),u.add(o))}return l.archives&&l.archives.length>0?l.archives.forEach(i=>{const a=parseInt(i.year);if(u.has(a))return;const c=i.data?i.data.find(m=>m.disease===t&&m.prefecture===e):null;c&&(n.push({year:i.year,data:c.history}),u.add(a))}):console.log("No archives available yet for yearDataSets."),n}function ne(t,e){H();const n=document.createElement("div");n.className="disease-card expanded expanded-modal modal-expanded",n.dataset.disease=t;const o=document.createElement("div");o.className="card-header";const u=document.createElement("h4");u.textContent=`${e} ${$(t)}`,o.appendChild(u);const i=document.createElement("button");i.className="close-expanded-btn modal-close-button",i.textContent="×",i.setAttribute("aria-label","閉じる"),i.onclick=H,n.appendChild(i),n.appendChild(o);const a=document.createElement("div");a.className="chart-container";const c=`expanded-chart-${t}`,m=document.createElement("canvas");m.id=c,a.appendChild(m),n.appendChild(a),document.body.appendChild(n);const s=document.getElementById("card-backdrop");if(s){s.classList.add("active");const d=()=>{H(),s.removeEventListener("click",d)};s.addEventListener("click",d)}const h=J(t,e),r=O(t);requestAnimationFrame(()=>{z(c,t,e,h,r,a)})}function H(){const t=document.querySelector(".disease-card.expanded-modal");if(t){const n=t.querySelector("canvas");n&&n.chart&&n.chart.destroy(),t.remove()}const e=document.getElementById("card-backdrop");e&&e.classList.remove("active")}const F=window.showPrefectureChart=function(t,e){f=t,D=null,document.getElementById("map-view").classList.add("hidden");const n=document.getElementById("pref-chart-container");n.classList.remove("hidden"),n.innerHTML="";const o=document.createElement("div");o.classList.add("pref-chart-header");const u=document.createElement("h3");u.textContent=`${t} ${$(e)}`,u.classList.add("pref-chart-title"),o.appendChild(u);const i=document.createElement("button");if(i.id="back-to-map-btn",i.textContent="戻る",o.appendChild(i),n.appendChild(o),i.addEventListener("click",()=>{document.getElementById("map-view").classList.remove("hidden"),document.getElementById("pref-chart-container").classList.add("hidden"),f=null,D&&typeof window.updateDetailPanel=="function"&&l&&window.updateDetailPanel(D,l,A,null)}),typeof window.getRegionIdByPrefecture=="function"&&typeof window.updateDetailPanel=="function"&&l){const r=window.getRegionIdByPrefecture(t);r&&window.updateDetailPanel(r,l,e,t)}if(e==="ARI"){const r=document.createElement("div");r.className="pref-chart-wrapper pref-chart-message-wrapper",n.appendChild(r);const d=document.createElement("p");d.className="pref-chart-message",d.textContent="急性呼吸器感染症 (ARI) の週次推移データはありません。",r.appendChild(d);return}const a=document.createElement("div");if(a.className="pref-chart-wrapper",n.appendChild(a),P(a),e==="ARI"){b(a);const r=document.createElement("p");r.className="pref-chart-message",r.textContent="急性呼吸器感染症 (ARI) の週次推移データはありません。",a.appendChild(r)}else{const r=document.createElement("canvas");r.id="prefectureHistoryChart",a.appendChild(r)}const c=[],m=new Date().getFullYear(),s=l.current.history.find(r=>r.disease===e&&r.prefecture===t);s&&c.push({year:m,data:s.history}),l.archives&&l.archives.forEach(r=>{if(parseInt(r.year)===m)return;const d=r.data.find(I=>I.disease===e&&I.prefecture===t);d&&c.push({year:r.year,data:d.history})});const h=l.isLoadingArchives;if(c.length===0&&!h){console.warn(`No history data for ${t} (${e}) across all years.`),b(a);const r=document.createElement("p");r.classList.add("no-data-message-inline"),r.textContent="データがありません。",a.innerHTML="",a.appendChild(r)}else{const r=O(e);if(z("prefectureHistoryChart",e,t,c,r,a),h){const d=document.createElement("div");d.className="archive-loading-indicator",d.textContent="過去のデータを読み込み中...",d.style.position="absolute",d.style.top="10px",d.style.right="10px",d.style.backgroundColor="rgba(255, 255, 255, 0.8)",d.style.padding="4px 8px",d.style.borderRadius="4px",d.style.fontSize="12px",d.style.color="#666",d.style.zIndex="10",a.style.position="relative",a.appendChild(d),b(a)}else b(a)}};window.showPrefectureChart=F;function Y(t){console.log("DEBUG: switchView called with viewId:",t),["main-view","other-diseases-list-view"].forEach(n=>{const o=document.getElementById(n);o&&(n===t?(o.classList.remove("hidden"),console.log(`DEBUG: Removed hidden from ${n}`)):(o.classList.add("hidden"),console.log(`DEBUG: Added hidden to ${n}`)))})}function V(t="全国"){const e=document.getElementById("other-diseases-grid");if(!e)return;for(;e.firstChild;)e.removeChild(e.firstChild);const n=document.getElementById("other-diseases-title");n&&(n.textContent=`その他の感染症（${t}）`);const o=document.getElementById("prefecture-select");o&&(o.value=t);const u=q.filter(a=>!["Influenza","COVID-19","ARI"].includes(a.key)),i=[];u.forEach(a=>{const c=document.createElement("div");c.className="disease-card",c.dataset.disease=a.key;const m=document.createElement("div");m.className="card-header";const s=document.createElement("h4");s.textContent=a.name;const h=document.createElement("button");h.className="expand-action-btn",h.setAttribute("aria-label","拡大表示"),h.innerHTML="";const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("xmlns","http://www.w3.org/2000/svg"),r.setAttribute("width","20"),r.setAttribute("height","20"),r.setAttribute("viewBox","0 0 24 24"),r.setAttribute("fill","none"),r.setAttribute("stroke","currentColor"),r.setAttribute("stroke-width","2"),r.setAttribute("stroke-linecap","round"),r.setAttribute("stroke-linejoin","round");const d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d","M12 5v14M5 12h14"),r.appendChild(d),h.appendChild(r),m.appendChild(s),m.appendChild(h),c.appendChild(m);const I=document.createElement("div");I.className="chart-container";const L=document.createElement("canvas");L.id=`chart-${a.key}`,I.appendChild(L),c.appendChild(I),e.appendChild(c),P(I);const N=c.querySelector(".expand-action-btn");N&&N.addEventListener("click",g=>{g.stopPropagation(),ne(a.key,t)}),i.push({disease:a,chartContainer:I,canvas:L})}),requestAnimationFrame(()=>{let a=0;function c(){if(a>=i.length)return;const{disease:m,chartContainer:s,canvas:h}=i[a],r=J(m.key,t);if(r.length>0){const d=O(m.key);z(`chart-${m.key}`,m.key,t,r,d,s)}else{b(s);const d=document.createElement("p");for(d.textContent="データがありません";s.firstChild;)s.removeChild(s.firstChild);s.appendChild(d),s.classList.add("chart-container-no-data")}a++,a<i.length&&setTimeout(c,0)}c()})}function T(){const t=document.getElementById("region-content");if(t){const n=document.createElement("p");n.className="placeholder-text",n.textContent="地図上のエリアをクリックすると詳細が表示されます。",t.replaceChildren(n)}const e=document.getElementById("region-title");e&&(e.textContent="地域詳細")}function S(t){const e=document.body;t?e.classList.add("loading"):e.classList.remove("loading")}async function ae(){try{S(!0),R&&(R.destroy(),R=null);const t=document.getElementById("prefectureHistoryChart");t&&t.chart&&t.chart.destroy();const e=document.getElementById("summary-cards");if(e){e.innerHTML="";const a=document.createElement("div");a.className="skeleton-card-wrapper";for(let c=0;c<5;c++){const m=document.createElement("div");m.className="skeleton-card",m.innerHTML='<div class="skeleton skeleton-title"></div><div class="skeleton skeleton-value"></div><div class="skeleton skeleton-status"></div>',a.appendChild(m)}e.appendChild(a)}const n=document.getElementById("japan-map");if(n){n.innerHTML="";const a=document.createElement("div");a.className="skeleton skeleton-map",n.appendChild(a)}const o=document.getElementById("chart-view");o&&(o.innerHTML="",P(o));const u=document.getElementById("region-content");if(u&&D){u.innerHTML="";const a=document.createElement("div");a.className="skeleton skeleton-chart large",u.appendChild(a)}await localforage.removeItem(k.CURRENT_DATA_KEY),await localforage.removeItem(k.ARCHIVE_DATA_KEY),console.log("Cache cleared for infection data reload."),await X(),D&&typeof window.updateDetailPanel=="function"&&l&&window.updateDetailPanel(D,l,A,f),f&&F(f,A);const i=document.getElementById("other-diseases-list-view");if(i&&!i.classList.contains("hidden")){const a=document.getElementById("prefecture-select");V(a?a.value:"全国")}}catch(t){console.error("Error reloading data:",t);const e=document.getElementById("summary-cards");if(e){for(;e.firstChild;)e.removeChild(e.firstChild);const n=document.createElement("p");n.className="error",n.textContent=`データの再取得に失敗しました。詳細: ${t.message}`,e.appendChild(n)}}finally{S(!1)}}function oe(){const t=document.getElementById("accordion-toggle"),e=document.getElementById("accordion-content");t&&e&&t.addEventListener("click",()=>{e.classList.toggle("open"),t.classList.toggle("open")});const n=document.getElementById("reload-btn");n&&n.addEventListener("click",ae);const o=document.getElementById("detail-panel-close-btn");o&&o.addEventListener("click",T);const u=document.getElementById("card-backdrop");u&&u.addEventListener("click",()=>{document.querySelector(".disease-card.expanded-modal")&&H();const c=document.querySelector(".disease-card.expanded:not(.expanded-modal)");c&&(c.classList.remove("expanded"),u.classList.remove("active"))});const i=document.getElementById("back-to-map-btn");i&&i.addEventListener("click",()=>{document.getElementById("map-view").classList.remove("hidden"),document.getElementById("pref-chart-container").classList.add("hidden"),f=null});const a=document.getElementById("other-diseases-btn");a&&a.addEventListener("click",()=>{const c=document.getElementById("other-diseases-list-view");c&&!c.classList.contains("hidden")?(a.textContent="その他の感染症",document.getElementById("summary-cards").classList.remove("hidden"),Y("main-view")):(a.textContent="インフルエンザ・COVID-19",document.getElementById("summary-cards").classList.add("hidden"),Y("other-diseases-list-view"),V(f||"全国"));const s=document.getElementById("prefecture-select");s&&s.options.length<=1&&(["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"].forEach(r=>{const d=document.createElement("option");d.value=r,d.textContent=r,s.appendChild(d)}),f&&(s.value=f),s.addEventListener("change",r=>{V(r.target.value)}))})}async function X(){try{const t=Date.now();let e=null;try{const n=await localforage.getItem(k.CURRENT_DATA_KEY);n&&t-n.timestamp<k.MAIN_EXPIRY&&(e=n.data)}catch(n){console.warn("Current data cache check failed:",n)}e||(e=await Z()),l.current=e,l.current&&l.current.meta&&l.current.meta.dateInfo?W(l.current.meta.dateInfo):W(""),Q(l),U(A,l),S(!1),l.isLoadingArchives=!0,K().then(n=>{console.log("Archives loaded in background:",n.length,"years"),l.archives=n,l.isLoadingArchives=!1,j()}).catch(n=>{console.warn("Background archive fetch failed:",n),l.isLoadingArchives=!1,j()})}catch(t){throw console.error("Error in loadAndRenderData:",t),t}}function j(){f&&F(f,A);const t=document.getElementById("other-diseases-list-view");if(t&&!t.classList.contains("hidden")){const e=document.getElementById("prefecture-select");V(e?e.value:"全国")}}function W(t){const e=document.getElementById("update-date");if(!e)return;const n=t.match(/(\d{4})年(\d{1,2})週(?:\((.*?)\))?/);if(n){const o=n[1],u=n[2];let i=n[3];i?(i=i.replace(/月/g,"/").replace(/日/g,"").replace(/[〜~]/g,"～"),e.textContent=`${o}年 第${u}週 （${i}）`):e.textContent=`${o}年 第${u}週`}else e.textContent=new Date().toLocaleDateString("ja-JP")}async function re(){try{S(!0),oe(),console.log("DEBUG: initEventListeners called"),await X(),S(!1)}catch(t){console.error("Error fetching data:",t);const e=document.getElementById("summary-cards");if(e){for(;e.firstChild;)e.removeChild(e.firstChild);const n=document.createElement("p");n.className="error",n.textContent=`データの取得に失敗しました。詳細: ${t.message}`,e.appendChild(n)}S(!1)}}document.addEventListener("DOMContentLoaded",re);
