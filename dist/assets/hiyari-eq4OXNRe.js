import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{n as D}from"./utils-cz7vvGbo.js";import{s as b}from"./ui-C1FH7vrA.js";import"./MainHeader-Cz0INnUv.js";import{t as $}from"./typing-animation-B3fvp7eE.js";const H="/hiyari-proxy/proxy",X=30,e={searchInput:null,searchBtn:null,filterInput:null,randomBtn:null,resultsContainer:null,loadingIndicator:null,errorMsg:null,mainHeader:null,mainFooter:null,reloadButton:null,usageGuide:null,shareBtn:null};let f=[],g=0;function k(){e.searchInput=document.getElementById("search-input"),e.searchBtn=document.getElementById("search-btn"),e.filterInput=document.getElementById("filter-input"),e.randomBtn=document.getElementById("random-btn"),e.resultsContainer=document.getElementById("results-container"),e.loadingIndicator=document.getElementById("loading"),e.errorMsg=document.getElementById("error-msg"),e.mainHeader=document.getElementById("mainHeader"),e.mainFooter=document.getElementById("mainFooter"),e.reloadButton=document.getElementById("reload-button"),e.usageGuide=document.getElementById("usage-guide"),e.shareBtn=document.getElementById("share-btn")}function v(t){t?e.loadingIndicator.classList.remove("hidden"):e.loadingIndicator.classList.add("hidden")}function G(t){e.errorMsg.textContent=t,e.errorMsg.classList.remove("hidden")}function w(){e.errorMsg.classList.add("hidden")}function j(t,n,a=0){const o=new URLSearchParams;o.append("count","30"),o.append("start",a.toString()),o.append("order","2");const c=D(t).trim(),m=D(n).trim();["DATMEDNAME","DATGENERIC","DATCONTENTTEXT","DATFACTORTEXT","DATIMPROVEMENTTEXT","DATESTIMATEDTEXT","DATEFFORTTEXT"].forEach(r=>o.append("item",r));const s=[c,m].filter(Boolean).join(" ");return s&&(o.append("word",s),o.append("condition","all")),`${H}?${o.toString()}`}async function C(t=0){const n=e.searchInput.value.trim(),a=e.filterInput.value.trim();if(!n&&!a){e.resultsContainer.innerHTML="",w(),document.body.classList.remove("search-mode"),e.usageGuide&&e.usageGuide.classList.remove("hidden");return}const o=d=>{if(!d)return{include:[],exclude:[]};const s=d.split(/[\s　]+/).filter(l=>l.length>0),r=[],i=[];return s.forEach(l=>{l.startsWith("ー")&&l.length>1?i.push(D(l.substring(1))):r.push(D(l))}),{include:r,exclude:i}},c=o(n),m=o(a);v(!0),w(),t===0&&(e.resultsContainer.innerHTML="",f=[],g=0,e.usageGuide&&e.usageGuide.classList.add("hidden"));try{const d=performance.now(),s=c.include.join(" "),r=m.include.join(" "),i=j(s,r,t);console.log(`[Hiyari Debug] Fetching from: ${i}`);const l=await fetch(i),E=performance.now();if(console.log(`[Hiyari Debug] Response status: ${l.status} (Fetch time: ${Math.round(E-d)}ms)`),!l.ok)throw new Error(`API Error: ${l.status}`);const p=await l.text(),T=performance.now();console.log(`[Hiyari Debug] Response length: ${p.length}`);const u=new DOMParser().parseFromString(p,"application/xml"),B=performance.now();console.log(`[Hiyari Debug] Root Node: ${u.documentElement.nodeName} (Parse time: ${Math.round(B-T)}ms)`);const L=u.querySelector("Error");if(L)throw new Error(`API Error: ${L.textContent}`);const x=u.querySelectorAll("PHARMACY_REPORT");if(console.log(`[Hiyari Debug] Reports found: ${x.length}`),x.length===0){if(t===0){const h=document.createElement("p");h.className="col-span-full text-center text-gray-500 py-8",h.textContent="該当する事例は見つかりませんでした。",e.resultsContainer.appendChild(h),document.body.classList.remove("search-mode")}else b("これ以上の事例はありません","info");return}const A=Array.from(x).map(_).filter(h=>{const N=(F,I)=>{const P=JSON.stringify(F),R=D(P),U=I.exclude.length===0||!I.exclude.some(M=>R.includes(M));return I.include.every(M=>R.includes(M))&&U};return N(h,c)&&N(h,m)});if(A.length===0){if(t===0){const h=document.createElement("p");h.className="col-span-full text-center text-gray-500 py-8",h.textContent="条件にヒットする事例はありませんでした。",e.resultsContainer.appendChild(h),document.body.classList.remove("search-mode")}else b("このページの事例は全てフィルタリングされました。","info");return}A.length>0?(f=[...f,...A],S(A),g+=A.length,document.body.classList.add("search-mode"),Y()):t===0||b("このページの事例は全てフィルタリングされました。","info")}catch(d){console.error("Fetching incidents failed:",d),G(`データ取得に失敗しました: ${d.message}`)}finally{v(!1)}}function _(t){const n=r=>{const i=t.querySelector(r);return i?i.textContent.trim():"記載なし"},a={"01":"調剤に関するヒヤリ・ハット事例","02":"疑義照会や処方医への情報提供に関する事例","03":"特定保険医療材料等に関する事例","04":"一般用医薬品等の販売に関する事例"},o={"01":"レセコンの入力間違い","02":"薬剤取り違え（異なる成分）","03":"薬剤取り違え（同成分）","04":"数量間違い","05":"剤形間違い","06":"規格間違い","07":"用法間違い","08":"患者間違い","09":"その他"},c={"01":"処方箋やその記載のされ方の要因","02":"調剤方法の要因","03":"鑑査方法の要因","04":"患者の要因","05":"医薬品の要因","06":"情報システムの要因","07":"その他の要因"},m={100101:"判断誤り",100102:"手順不遵守",100103:"スタッフ間のコミュニケーション不足・齟齬",100104:"患者とのコミュニケーション不足・齟齬",100199:"その他",110101:"知識不足",110102:"技術・手技が未熟",110103:"慣れ・慢心",110104:"焦り・慌て",110105:"疲労・体調不良・身体的不調",110106:"心配ごと等心理的状態",110199:"その他",120101:"医薬品の名称類似",120102:"医薬品や包装の外観類似",120103:"医薬品包装表示・添付文書の要因",120104:"処方箋やその記載のされ方の要因",120105:"コンピューターシステムの使いにくさ・不具合",120106:"調剤設備・調剤機器の使いにくさ・不具合",120107:"薬剤服用歴などの記録の不備",120108:"調剤室の環境的な要因",120109:"調剤室以外の環境的な要因",120199:"その他",130101:"繁忙であった",130102:"標榜する営業時間外であった",130103:"普段とは異なる業務状況だった",130199:"その他",140101:"教育訓練のなされ方",140102:"設備機器等の管理",140103:"薬局内のルールや管理の体制・仕方",140104:"薬局内の風土・雰囲気",140199:"その他",150101:"患者や家族の不注意",150102:"患者や家族の理解力・誤解",150103:"患者や家族のコンプライアンス・協力態度",150199:"その他"},d={160101:"患者とのコミュニケーション不足・齟齬",160102:"カルテ記載の不備",160103:"コンピューターシステムの使いにくさ・不具合",160104:"連携不足",160105:"知識不足",160106:"判断誤り",160107:"処方内容の確認不足",160199:"その他",170101:"医薬品の名称類似",170102:"患者や家族の要因",170199:"その他"},s=r=>{const i=t.querySelectorAll(r);if(i.length===0)return"N/A";let l=[];return i.forEach(E=>{const p=E.getAttribute("CODE"),T=E.textContent;let y=T.replace(/\s*\(コード:\s*[^)]+\)/g,"").trim(),u="";r==="DATSUMMARY"?u=a[p]||"不明な事例区分":r==="DATMONTH"?u={"01":"1月","02":"2月","03":"3月","04":"4月","05":"5月","06":"6月","07":"7月","08":"8月","09":"9月",10:"10月",11:"11月",12:"12月"}[p]||`不明な月 (${p})`:r==="DATCONTENTTEXT"?u=o[p]||"":r==="DATFACTORTEXT"?u=c[p]||"":r==="DATFACTOR"?u=m[p]||"":r==="DATFACTORDOUBT"&&(u=d[p]||""),y=u,T&&T.trim()!==""&&u!==T.trim()&&r.includes("TEXT")&&(y=`${u} ${T.trim()}`),y&&l.push(y)}),l.join("<br>")||"N/A"};return{year:n("DATYEAR"),month:s("DATMONTH"),summary:s("DATSUMMARY"),content:s("DATCONTENTTEXT"),factor:s("DATFACTORTEXT"),factors:s("LSTFACTOR DATFACTOR"),factorDoubts:s("LSTFACTORDOUBT DATFACTORDOUBT"),improvement:n("DATIMPROVEMENTTEXT"),estimatedText:n("DATESTIMATEDTEXT"),effortText:n("DATEFFORTTEXT"),medNames:Array.from(t.querySelectorAll("DATMEDNAME")).map(r=>r.textContent.trim()).join(" "),genericNames:Array.from(t.querySelectorAll("DATGENERIC")).map(r=>r.textContent.trim()).join(" "),patientAge:n("DATPATIENTAGE")}}function O(){if(f.length-g>0){const n=f.slice(g,g+X);S(n),g+=n.length}else C(g)}function Y(){let t=document.getElementById("load-more-btn");t||(t=document.createElement("button"),t.id="load-more-btn",t.className="col-span-full mx-auto bg-white text-indigo-600 border border-indigo-600 font-semibold rounded-lg px-6 py-2 hover:bg-indigo-50 transition-colors mt-4",t.textContent="さらに表示",t.addEventListener("click",O),e.resultsContainer.parentNode.appendChild(t)),t.classList.remove("hidden")}function S(t){if(t.length===0&&g===0){const n=document.createElement("p");n.className="col-span-full text-center text-gray-500 py-8",n.textContent="関連する事例は見つかりませんでした。",e.resultsContainer.appendChild(n);return}t.forEach(n=>{const a=document.createElement("div");a.className="bg-white rounded-xl shadow-lg border border-slate-200 p-4 transition-transform duration-200 hover:scale-[1.02]";const o=(s,r)=>{if(!r||r==="記載なし"||r==="N/A")return null;const i=document.createElement("p");i.className="text-sm text-gray-700 leading-relaxed mb-2";const l=document.createElement("strong");l.className="font-semibold text-indigo-600 border-b border-slate-300 pb-0.5 mb-1 inline-block",l.textContent=s,i.appendChild(l),i.appendChild(document.createElement("br"));const E=r.split("<br>");return E.forEach((p,T)=>{i.appendChild(document.createTextNode(p)),T<E.length-1&&i.appendChild(document.createElement("br"))}),i},c=document.createElement("h2");c.className="text-lg font-bold text-indigo-700 border-b-2 border-slate-200 pb-2 mb-3",c.textContent=n.summary,a.appendChild(c);const m=document.createElement("p");m.className="text-sm text-gray-500 text-right mb-3",m.textContent=`発生年月: ${n.year}年${n.month}`,a.appendChild(m);const d=o("事例の詳細:",n.content);if(d&&a.appendChild(d),n.summary.includes("疑義照会")){const s=o("推定される要因:",n.estimatedText);s&&a.appendChild(s);const r=o("薬局での取り組み:",n.effortText);r&&a.appendChild(r)}else{const s=o("背景・要因:",n.factor);s&&a.appendChild(s);const r=o("発生要因:",n.factors);r&&a.appendChild(r);const i=o("発生要因(疑義照会):",n.factorDoubts);i&&a.appendChild(i);const l=o("改善策:",n.improvement);l&&a.appendChild(l)}e.resultsContainer.appendChild(a)})}function q(){if(f.length!==0){for(let t=f.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[f[t],f[n]]=[f[n],f[t]]}e.resultsContainer.innerHTML="",g=0,O()}}async function V(){const t=e.searchInput?.value?.trim()||"",n=e.filterInput?.value?.trim()||"",a=new URLSearchParams;t&&a.set("keyword",t),n&&a.set("filter",n);const c=`${window.location.origin+window.location.pathname}?${a.toString()}`;try{await navigator.clipboard.writeText(c),b("検索条件のURLをクリップボードにコピーしました","success")}catch(m){console.error("Failed to copy to clipboard:",m),b("URLのコピーに失敗しました","error")}}function W(){k(),e.searchInput&&e.searchInput.addEventListener("keypress",o=>{o.key==="Enter"&&C()}),e.filterInput&&e.filterInput.addEventListener("keypress",o=>{o.key==="Enter"&&C()}),e.searchBtn&&e.searchBtn.addEventListener("click",()=>{console.log("[Hiyari Debug] Search button clicked"),C()}),e.randomBtn&&e.randomBtn.addEventListener("click",q),e.reloadButton&&e.reloadButton.addEventListener("click",()=>{e.searchInput&&(e.searchInput.value=""),e.filterInput&&(e.filterInput.value=""),e.resultsContainer&&(e.resultsContainer.innerHTML="");const o=document.getElementById("load-more-btn");o&&o.remove(),w(),document.body.classList.remove("search-mode"),e.usageGuide&&e.usageGuide.classList.remove("hidden");const c=new URL(window.location);c.search="",window.history.pushState({},"",c)}),e.shareBtn&&e.shareBtn.addEventListener("click",()=>V());const t=new URLSearchParams(window.location.search),n=t.get("drugName")||t.get("ingredientName")||t.get("keyword"),a=t.get("filter");n&&e.searchInput&&(e.searchInput.value=n),a&&e.filterInput&&(e.filterInput.value=a),(n||a)&&e.searchInput&&C()}document.addEventListener("DOMContentLoaded",W);document.addEventListener("DOMContentLoaded",()=>{const t=[{element:document.getElementById("search-input"),text:"医薬品名または成分名を入力",speed:100},{element:document.getElementById("filter-input"),text:"事例内容、背景・要因で検索",speed:100}];$(t,300)});
