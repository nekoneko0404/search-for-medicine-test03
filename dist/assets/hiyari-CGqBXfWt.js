import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{n as y}from"./utils-cz7vvGbo.js";import{s as M}from"./ui-C1FH7vrA.js";import"./MainHeader-Cz0INnUv.js";import{t as O}from"./typing-animation-B3fvp7eE.js";const S="/hiyari-proxy/proxy",F=30,e={searchInput:null,searchBtn:null,filterInput:null,randomBtn:null,resultsContainer:null,loadingIndicator:null,errorMsg:null,mainHeader:null,mainFooter:null,reloadButton:null,usageGuide:null,shareBtn:null};let h=[],T=0;function P(){e.searchInput=document.getElementById("search-input"),e.searchBtn=document.getElementById("search-btn"),e.filterInput=document.getElementById("filter-input"),e.randomBtn=document.getElementById("random-btn"),e.resultsContainer=document.getElementById("results-container"),e.loadingIndicator=document.getElementById("loading"),e.errorMsg=document.getElementById("error-msg"),e.mainHeader=document.getElementById("mainHeader"),e.mainFooter=document.getElementById("mainFooter"),e.reloadButton=document.getElementById("reload-button"),e.usageGuide=document.getElementById("usage-guide"),e.shareBtn=document.getElementById("share-btn")}function w(n){n?e.loadingIndicator.classList.remove("hidden"):e.loadingIndicator.classList.add("hidden")}function U(n){e.errorMsg.textContent=n,e.errorMsg.classList.remove("hidden")}function x(){e.errorMsg.classList.add("hidden")}function $(n,t){const r=new URLSearchParams;r.append("count","100"),r.append("order","2");const s=y(n).replace(/ー/g," ").trim(),d=y(t).replace(/ー/g," ").trim();if(s&&!d)r.append("item","DATMEDNAME"),r.append("item","DATGENERIC"),r.append("word",s),r.append("condition","any");else{const c=[s,d].filter(Boolean).join(" ");c&&(r.append("word",c),s&&d&&r.append("condition","all"))}return`${S}?${r.toString()}`}async function A(){const n=e.searchInput.value.trim(),t=e.filterInput.value.trim();if(!n&&!t){e.resultsContainer.innerHTML="",x(),document.body.classList.remove("search-mode"),e.usageGuide&&e.usageGuide.classList.remove("hidden");return}const r=c=>{if(!c)return{include:[],exclude:[]};const g=c.split(/[\s　]+/).filter(a=>a.length>0),i=[],o=[];return g.forEach(a=>{a.startsWith("ー")&&a.length>1?o.push(y(a.substring(1))):i.push(y(a))}),{include:i,exclude:o}},s=r(n),d=r(t);w(!0),x(),e.resultsContainer.innerHTML="",T=0,e.usageGuide&&e.usageGuide.classList.add("hidden");try{const c=s.include.join(" "),g=d.include.join(" "),i=$(c,g);console.log(`[Hiyari Debug] Fetching from: ${i}`);const o=await fetch(i);if(console.log(`[Hiyari Debug] Response status: ${o.status}`),!o.ok)throw new Error(`API Error: ${o.status}`);const a=await o.text();console.log(`[Hiyari Debug] Response length: ${a.length}`),console.log(`[Hiyari Debug] Response Start: ${a.substring(0,500)}`),console.log(`[Hiyari Debug] Response End: ${a.substring(a.length-200)}`);const f=new DOMParser().parseFromString(a,"application/xml");console.log(`[Hiyari Debug] Root Node: ${f.documentElement.nodeName}`);const u=f.querySelector("Error");if(u)throw new Error(`API Error: ${u.textContent}`);const m=f.querySelectorAll("PHARMACY_REPORT");if(console.log(`[Hiyari Debug] Reports found: ${m.length}`),m.length===0){const l=document.createElement("p");l.className="col-span-full text-center text-gray-500 py-8",l.textContent="該当する事例は見つかりませんでした。",e.resultsContainer.appendChild(l),document.body.classList.remove("search-mode");return}if(h=Array.from(m).map(H).filter(l=>{const C=(B,b)=>{const L=JSON.stringify(B),I=y(L),N=b.include.every(D=>I.includes(D)),v=b.exclude.length===0||!b.exclude.some(D=>I.includes(D));return N&&v};return C(l,s)&&C(l,d)}),h.length===0){const l=document.createElement("p");l.className="col-span-full text-center text-gray-500 py-8",l.textContent="条件にヒットする事例はありませんでした。",e.resultsContainer.appendChild(l),document.body.classList.remove("search-mode");return}document.body.classList.add("search-mode"),R()}catch(c){console.error("Fetching incidents failed:",c),U(`データ取得に失敗しました: ${c.message}`)}finally{w(!1)}}function H(n){const t=o=>{const a=n.querySelector(o);return a?a.textContent.trim():"記載なし"},r={"01":"調剤に関するヒヤリ・ハット事例","02":"疑義照会や処方医への情報提供に関する事例","03":"特定保険医療材料等に関する事例","04":"一般用医薬品等の販売に関する事例"},s={"01":"レセコンの入力間違い","02":"薬剤取り違え（異なる成分）","03":"薬剤取り違え（同成分）","04":"数量間違い","05":"剤形間違い","06":"規格間違い","07":"用法間違い","08":"患者間違い","09":"その他"},d={"01":"処方箋やその記載のされ方の要因","02":"調剤方法の要因","03":"鑑査方法の要因","04":"患者の要因","05":"医薬品の要因","06":"情報システムの要因","07":"その他の要因"},c={100101:"判断誤り",100102:"手順不遵守",100103:"スタッフ間のコミュニケーション不足・齟齬",100104:"患者とのコミュニケーション不足・齟齬",100199:"その他",110101:"知識不足",110102:"技術・手技が未熟",110103:"慣れ・慢心",110104:"焦り・慌て",110105:"疲労・体調不良・身体的不調",110106:"心配ごと等心理的状態",110199:"その他",120101:"医薬品の名称類似",120102:"医薬品や包装の外観類似",120103:"医薬品包装表示・添付文書の要因",120104:"処方箋やその記載のされ方の要因",120105:"コンピューターシステムの使いにくさ・不具合",120106:"調剤設備・調剤機器の使いにくさ・不具合",120107:"薬剤服用歴などの記録の不備",120108:"調剤室の環境的な要因",120109:"調剤室以外の環境的な要因",120199:"その他",130101:"繁忙であった",130102:"標榜する営業時間外であった",130103:"普段とは異なる業務状況だった",130199:"その他",140101:"教育訓練のなされ方",140102:"設備機器等の管理",140103:"薬局内のルールや管理の体制・仕方",140104:"薬局内の風土・雰囲気",140199:"その他",150101:"患者や家族の不注意",150102:"患者や家族の理解力・誤解",150103:"患者や家族のコンプライアンス・協力態度",150199:"その他"},g={160101:"患者とのコミュニケーション不足・齟齬",160102:"カルテ記載の不備",160103:"コンピューターシステムの使いにくさ・不具合",160104:"連携不足",160105:"知識不足",160106:"判断誤り",160107:"処方内容の確認不足",160199:"その他",170101:"医薬品の名称類似",170102:"患者や家族の要因",170199:"その他"},i=o=>{const a=n.querySelectorAll(o);if(a.length===0)return"N/A";let p=[];return a.forEach(f=>{const u=f.getAttribute("CODE"),m=f.textContent;let E=m.replace(/\s*\(コード:\s*[^)]+\)/g,"").trim(),l="";o==="DATSUMMARY"?l=r[u]||"不明な事例区分":o==="DATMONTH"?l={"01":"1月","02":"2月","03":"3月","04":"4月","05":"5月","06":"6月","07":"7月","08":"8月","09":"9月",10:"10月",11:"11月",12:"12月"}[u]||`不明な月 (${u})`:o==="DATCONTENTTEXT"?l=s[u]||"":o==="DATFACTORTEXT"?l=d[u]||"":o==="DATFACTOR"?l=c[u]||"":o==="DATFACTORDOUBT"&&(l=g[u]||""),E=l,m&&m.trim()!==""&&l!==m.trim()&&o.includes("TEXT")&&(E=`${l} ${m.trim()}`),E&&p.push(E)}),p.join("<br>")||"N/A"};return{year:t("DATYEAR"),month:i("DATMONTH"),summary:i("DATSUMMARY"),content:i("DATCONTENTTEXT"),factor:i("DATFACTORTEXT"),factors:i("LSTFACTOR DATFACTOR"),factorDoubts:i("LSTFACTORDOUBT DATFACTORDOUBT"),improvement:t("DATIMPROVEMENTTEXT"),estimatedText:t("DATESTIMATEDTEXT"),effortText:t("DATEFFORTTEXT"),medNames:Array.from(n.querySelectorAll("DATMEDNAME")).map(o=>o.textContent.trim()).join(" "),genericNames:Array.from(n.querySelectorAll("DATGENERIC")).map(o=>o.textContent.trim()).join(" "),patientAge:t("DATPATIENTAGE")}}function R(){const n=h.slice(T,T+F);k(n),T+=n.length}function k(n){if(n.length===0&&T===0){const t=document.createElement("p");t.className="col-span-full text-center text-gray-500 py-8",t.textContent="関連する事例は見つかりませんでした。",e.resultsContainer.appendChild(t);return}n.forEach(t=>{const r=document.createElement("div");r.className="bg-white rounded-xl shadow-lg border border-slate-200 p-4 transition-transform duration-200 hover:scale-[1.02]";const s=(i,o)=>{if(!o||o==="記載なし"||o==="N/A")return null;const a=document.createElement("p");a.className="text-sm text-gray-700 leading-relaxed mb-2";const p=document.createElement("strong");p.className="font-semibold text-indigo-600 border-b border-slate-300 pb-0.5 mb-1 inline-block",p.textContent=i,a.appendChild(p),a.appendChild(document.createElement("br"));const f=o.split("<br>");return f.forEach((u,m)=>{a.appendChild(document.createTextNode(u)),m<f.length-1&&a.appendChild(document.createElement("br"))}),a},d=document.createElement("h2");d.className="text-lg font-bold text-indigo-700 border-b-2 border-slate-200 pb-2 mb-3",d.textContent=t.summary,r.appendChild(d);const c=document.createElement("p");c.className="text-sm text-gray-500 text-right mb-3",c.textContent=`発生年月: ${t.year}年${t.month}`,r.appendChild(c);const g=s("事例の詳細:",t.content);if(g&&r.appendChild(g),t.summary.includes("疑義照会")){const i=s("推定される要因:",t.estimatedText);i&&r.appendChild(i);const o=s("薬局での取り組み:",t.effortText);o&&r.appendChild(o)}else{const i=s("背景・要因:",t.factor);i&&r.appendChild(i);const o=s("発生要因:",t.factors);o&&r.appendChild(o);const a=s("発生要因(疑義照会):",t.factorDoubts);a&&r.appendChild(a);const p=s("改善策:",t.improvement);p&&r.appendChild(p)}e.resultsContainer.appendChild(r)})}function G(){if(h.length!==0){for(let n=h.length-1;n>0;n--){const t=Math.floor(Math.random()*(n+1));[h[n],h[t]]=[h[t],h[n]]}e.resultsContainer.innerHTML="",T=0,R()}}async function X(){const n=e.searchInput?.value?.trim()||"",t=e.filterInput?.value?.trim()||"",r=new URLSearchParams;n&&r.set("keyword",n),t&&r.set("filter",t);const d=`${window.location.origin+window.location.pathname}?${r.toString()}`;try{await navigator.clipboard.writeText(d),M("検索条件のURLをクリップボードにコピーしました","success")}catch(c){console.error("Failed to copy to clipboard:",c),M("URLのコピーに失敗しました","error")}}function j(){P(),e.searchInput&&e.searchInput.addEventListener("keypress",s=>{s.key==="Enter"&&A()}),e.filterInput&&e.filterInput.addEventListener("keypress",s=>{s.key==="Enter"&&A()}),e.searchBtn&&e.searchBtn.addEventListener("click",()=>{console.log("[Hiyari Debug] Search button clicked"),A()}),e.randomBtn&&e.randomBtn.addEventListener("click",G),e.reloadButton&&e.reloadButton.addEventListener("click",()=>{e.searchInput&&(e.searchInput.value=""),e.filterInput&&(e.filterInput.value=""),e.resultsContainer&&(e.resultsContainer.innerHTML=""),x(),document.body.classList.remove("search-mode"),e.usageGuide&&e.usageGuide.classList.remove("hidden");const s=new URL(window.location);s.search="",window.history.pushState({},"",s)}),e.shareBtn&&e.shareBtn.addEventListener("click",()=>X());const n=new URLSearchParams(window.location.search),t=n.get("drugName")||n.get("ingredientName")||n.get("keyword"),r=n.get("filter");t&&e.searchInput&&(e.searchInput.value=t),r&&e.filterInput&&(e.filterInput.value=r),(t||r)&&e.searchInput&&A()}document.addEventListener("DOMContentLoaded",j);document.addEventListener("DOMContentLoaded",()=>{const n=[{element:document.getElementById("search-input"),text:"医薬品名または成分名を入力",speed:100},{element:document.getElementById("filter-input"),text:"事例内容、背景・要因で検索",speed:100}];O(n,300)});
