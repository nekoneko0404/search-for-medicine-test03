import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("update-notice");if(e){const t=e.getAttribute("data-notice-id"),n=JSON.parse(localStorage.getItem("pollen_hidden_notices")||"[]");if(n.includes(t))e.remove();else{const o=document.getElementById("notice-close-btn"),r=document.getElementById("notice-hide-checkbox");o&&o.addEventListener("click",function(){r&&r.checked&&(n.push(t),localStorage.setItem("pollen_hidden_notices",JSON.stringify(n))),e.style.transition="opacity 0.3s, transform 0.3s",e.style.opacity="0",e.style.transform="translateX(100%)",setTimeout(()=>e.remove(),300)})}}});function I(e=new Date){return new Date(e.getTime()+324e5).toISOString().split("T")[0]}const R={API_ENDPOINT:"https://wxtech.weathernews.com/opendata/v1/pollen",ZOOM_THRESHOLD:11,CACHE_DURATION:600*1e3},F="https://pollen-worker.neko-neko-0404.workers.dev",b={cache:{},currentDate:"",currentMode:"hourly"};let B=null,w;const T={},O=new Set;let K=new Set;function U(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function A(e,t=!1){return t?e>=300?"#9C27B0":e>=150?"#f44336":e>=90?"#FFEB3B":e>=30?"#2196F3":"#FFFFFF":e>=30?"#9C27B0":e>=15?"#f44336":e>=9?"#FFEB3B":e>=3?"#2196F3":"#FFFFFF"}async function V(e,t,n){const o=`${e}-${t}-${n}`,r=Date.now();if(b.cache[o]){const s=b.cache[o];if(r-s.timestamp<R.CACHE_DURATION)return s.data}try{const s=await fetch(`${R.API_ENDPOINT}?citycode=${e}&start=${t}&end=${n}`);if(!s.ok)throw new Error("Network response was not ok");const a=(await s.text()).trim().split(`
`).slice(1).map(i=>{const[c,p,d]=i.split(",");let u=parseInt(d,10);(isNaN(u)||u<0)&&(u=-1);const f=new Date(p),S=p.split("T")[0];return{date:f,dateKey:S,pollen:u}});return b.cache[o]={data:a,timestamp:r},a}catch(s){return console.error("Fetch error:",s),[]}}function X(){M().catch(e=>console.error("Error in updateVisibleMarkers:",e))}function Q(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>e.apply(this,o),t)}}const j=new Set;async function M(){if(w)try{const e=w.getZoom(),t=w.getBounds(),n=w.getCenter();let o=new Set([1]);e>=6&&o.add(2),e>=8&&o.add(3);let r=CITIES.filter(l=>o.has(l.level)?t.contains(L.latLng(l.lat,l.lng)):!1);r.forEach(l=>{l._dist=Math.pow(l.lat-n.lat,2)+Math.pow(l.lng-n.lng,2)}),r.sort((l,y)=>l._dist-y._dist);let s=1e3,g=12,m=180;e<7&&(g=10,m=100),e>=7&&e<=9&&(g=15+(e-7)*5,m=200+(e-7)*50),e>=12&&(s=1e4,g=0,m=0);const a=(l,y)=>{const v=w.latLngToContainerPoint([l.lat,l.lng]),C=w.latLngToContainerPoint([y.lat,y.lng]);return Math.sqrt(Math.pow(v.x-C.x,2)+Math.pow(v.y-C.y,2))},i=w.getSize(),c=Math.sqrt(Math.pow(i.x/2,2)+Math.pow(i.y/2,2)),p=l=>{const y=w.latLngToContainerPoint([l.lat,l.lng]),v=w.latLngToContainerPoint(n),C=Math.sqrt(Math.pow(y.x-v.x,2)+Math.pow(y.y-v.y,2)),P=Math.min(1,C/c);return g+(m-g)*P},d=[],u=new Set;for(const l of r){if(d.length>=s)break;let y=!1;const v=p(l);for(const C of d)if(a(l,C)<v){y=!0;break}y||(d.push(l),u.add(l.code))}const f=d,S=new Set(f.map(l=>l.code));K=S;const D=[];for(const l of f){if(T[l.code])w.hasLayer(T[l.code])||T[l.code].addTo(w);else{const y=L.circleMarker([l.lat,l.lng],{radius:8,fillColor:"#ccc",color:"rgba(0, 0, 0, 0.3)",weight:1,opacity:1,fillOpacity:.8});y.cityCode=l.code,y.cityName=l.name,y.maxPollen=0;const v=U(l.code);y.bindPopup(`<div id="popup-${v}">読み込み中...</div>`,{maxWidth:350}),y.on("popupopen",()=>{B=l,q(l,y)}),y.on("popupclose",()=>{B=null}),T[l.code]=y,y.addTo(w)}!O.has(l.code)&&!j.has(l.code)&&D.push(l.code)}Object.keys(T).forEach(l=>{S.has(l)||w.hasLayer(T[l])&&w.removeLayer(T[l])});const h=20;for(let l=0;l<D.length;l+=h){const y=D.slice(l,l+h).filter(v=>K.has(v)&&!O.has(v)&&!j.has(v));if(y.length>0){y.forEach(v=>j.add(v));try{await Promise.all(y.map(v=>ee(v)))}finally{y.forEach(v=>j.delete(v))}}}}catch(e){console.error("Error in updateVisibleMarkers logic:",e)}}async function ee(e){if(O.has(e))return;const t=b.currentDate.replace(/-/g,""),n=new Date(b.currentDate);n.setDate(n.getDate()+1);let o=n.toISOString().split("T")[0].replace(/-/g,"");const r=I().replace(/-/g,"");o>r&&(o=r);const s=await V(e,t,o);if(s.length>0){const g=I(),m=b.currentDate===g;let a=0;if(m&&b.currentMode==="hourly"){const c=new Date,p=s.filter(u=>u.date<=c&&u.pollen!==null&&u.pollen>=0),d=p.length>0?p[p.length-1]:null;a=d?d.pollen:0}else a=s.filter(c=>c.dateKey===b.currentDate).reduce((c,p)=>c+(p.pollen>0?p.pollen:0),0);const i=T[e];if(i){const c=m&&b.currentMode==="hourly";i.isPast=!c,i.maxPollen=a,i.setStyle({fillColor:A(a,!c)}),O.add(e),w.getZoom()>=R.ZOOM_THRESHOLD&&Z(i);const p=k.getSettings();p&&p.cityCode===e&&k.updateRegisteredLocationUI()}}}function Z(e){const t=e.isPast?e.maxPollen*.4:e.maxPollen*8,n=A(e.maxPollen,e.isPast),o=n==="#FFFFFF"?"#999999":"#FFFFFF",r=`
        <div class="graph-tooltip-inner" style="display: flex; flex-direction: column; align-items: center;">
            <div style="width: 10px; height: ${Math.min(t,150)}px; background-color: ${n}; border: 1px solid ${o};"></div>
            <span style="font-size: 10px;">${e.maxPollen}</span>
        </div>
    `;e.getTooltip()?e.setTooltipContent(r):e.bindTooltip(r,{permanent:!0,direction:"top",className:"graph-tooltip",offset:[0,-10]})}async function q(e,t){const n=`popup-${e.code}`,o=document.getElementById(n);if(!o)return;const r=b.currentDate.replace(/-/g,""),s=new Date(b.currentDate);s.setDate(s.getDate()+1);let g=s.toISOString().split("T")[0].replace(/-/g,"");const m=I().replace(/-/g,"");g>m&&(g=m);const i=(await V(e.code,r,g)).filter(h=>h.dateKey===b.currentDate),c=b.currentDate.split("-").slice(1).join("/"),p=U(e.name),d=U(c),u=U(e.code);o.innerHTML=`
        <div class="popup-header">
            <span>${p} (${d})</span>
            <div>
                <button class="btn-trend">週間推移</button>
                <button class="btn-notification" title="通知設定"><i class="fas fa-bell"></i></button>
            </div>
        </div>
        <div class="popup-chart-container">
            <canvas id="chart-${u}"></canvas>
        </div>
    `;const f=o.querySelector(".btn-trend");f&&f.addEventListener("click",()=>showWeeklyTrend(e.code,e.name));const S=o.querySelector(".btn-notification");S&&S.addEventListener("click",()=>k.openSettings(e.code,e.name));const D=document.getElementById(`chart-${e.code}`).getContext("2d");new Chart(D,{type:"bar",data:{labels:i.map(h=>h.date.getHours()+"時"),datasets:[{label:"花粉数",data:i.map(h=>h.pollen>=0?h.pollen:0),backgroundColor:i.map(h=>A(h.pollen>=0?h.pollen:0)),borderColor:i.map(h=>{const l=A(h.pollen>=0?h.pollen:0);return l==="#FFFFFF"?"#999999":l}),borderWidth:1.5,barPercentage:.9,categoryPercentage:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:h=>`花粉数: ${h.raw}個`}}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1,font:{size:10}}},x:{ticks:{font:{size:10},maxRotation:0,autoSkip:!0,maxTicksLimit:8}}}}});try{const h=await te(e.lat,e.lng,b.currentDate);if(h){const l=document.createElement("div");l.className="weather-info",l.innerHTML=`
                <div class="weather-item">
                    <i class="fas fa-thermometer-half"></i>
                    <span>${h.temperature}°C</span>
                </div>
                <div class="weather-item">
                    <i class="fas fa-tint"></i>
                    <span>${h.precipitation}mm</span>
                </div>
                <div class="weather-item">
                    <i class="fas fa-wind"></i>
                    <span style="display: inline-block; transform: rotate(${h.windDirection}deg)">↓</span>
                    <span>${h.windSpeed}m/s</span>
                </div>
            `,o.insertBefore(l,o.children[1])}}catch(h){console.error("Weather fetch error:",h)}}async function te(e,t,n){const o=I(),r=n===o;try{let s;r?s=`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${t}&current=temperature_2m,precipitation,wind_speed_10m,wind_direction_10m&timezone=Asia%2FTokyo&windspeed_unit=ms`:s=`https://archive-api.open-meteo.com/v1/archive?latitude=${e}&longitude=${t}&daily=temperature_2m_max,precipitation_sum,wind_speed_10m_max,wind_direction_10m_dominant&timezone=Asia%2FTokyo&start_date=${n}&end_date=${n}&windspeed_unit=ms`;const g=await fetch(s);if(!g.ok)throw new Error("Weather API error");const m=await g.json();if(r){const a=m.current;return{temperature:a.temperature_2m,precipitation:a.precipitation,windSpeed:a.wind_speed_10m,windDirection:a.wind_direction_10m}}else{const a=m.daily;return{temperature:a.temperature_2m_max[0],precipitation:a.precipitation_sum[0],windSpeed:a.wind_speed_10m_max[0],windDirection:a.wind_direction_10m_dominant[0]}}}catch(s){return console.error(s),null}}window.showWeeklyTrend=async function(e,t){const n=document.getElementById("trend-modal"),o=document.getElementById("modal-city-name"),r=document.getElementById("trendChart"),s=document.getElementById("trend-loading"),g=U(t);o.textContent=`${g}の28日間推移 (花粉・気温・降水量)`,n.classList.add("show"),s.classList.remove("hidden"),r.style.opacity="0";const m=new Date(b.currentDate),a=new Date(m);a.setDate(a.getDate()-27);const i=a.toISOString().split("T")[0].replace(/-/g,""),c=new Date(m);c.setDate(c.getDate()+1);let p=c.toISOString().split("T")[0].replace(/-/g,"");const d=I().replace(/-/g,"");p>d&&(p=d);const u=a.toISOString().split("T")[0],f=b.currentDate,S=CITIES.find(E=>E.code===e),D=V(e,i,p);let h=Promise.resolve(null);if(S){const E=new Date;E.setDate(E.getDate()-90);const N=m>E;let _;N?_=`https://api.open-meteo.com/v1/forecast?latitude=${S.lat}&longitude=${S.lng}&daily=temperature_2m_max,precipitation_sum&timezone=Asia%2FTokyo&past_days=92&forecast_days=14`:_=`https://archive-api.open-meteo.com/v1/archive?latitude=${S.lat}&longitude=${S.lng}&daily=temperature_2m_max,precipitation_sum&timezone=Asia%2FTokyo&start_date=${u}&end_date=${f}`,h=fetch(_).then(x=>{if(!x.ok)throw new Error("Weather fetch failed");return x.json()}).catch(x=>(console.error("Weather data fetch error:",x),null))}const[l,y]=await Promise.all([D,h]),v={};l.forEach(E=>{const N=E.dateKey;v[N]||(v[N]={sum:0,count:0}),E.pollen>=0&&(v[N].sum+=E.pollen),v[N].count++});const C=[],P=new Date(a);for(;P<=m;)C.push(P.toISOString().split("T")[0]),P.setDate(P.getDate()+1);const Y=C.map(E=>v[E]?v[E].sum:null);let z=[],W=[];if(y&&y.daily){const E=y.daily.time,N=y.daily.temperature_2m_max,_=y.daily.precipitation_sum,x={};E.forEach(($,H)=>{x[$]={temp:N[H],precip:_[H]}}),C.forEach($=>{x[$]?(z.push(x[$].temp),W.push(x[$].precip)):(z.push(null),W.push(null))})}window.trendChartInstance&&window.trendChartInstance.destroy(),window.trendChartInstance=new Chart(r,{type:"bar",data:{labels:C.map(E=>E.slice(5)),datasets:[{label:"1日積算花粉数",data:Y,type:"line",borderColor:"#2196F3",backgroundColor:"#2196F3",yAxisID:"y",tension:.1,fill:!1,order:1},{label:"最高気温 (°C)",data:z,type:"line",borderColor:"#ff9800",backgroundColor:"#ff9800",yAxisID:"y1",tension:.3,borderDash:[5,5],pointStyle:"circle",pointRadius:3,fill:!1,order:0},{label:"降水量 (mm)",data:W,type:"bar",backgroundColor:"rgba(52, 152, 219, 0.3)",borderColor:"rgba(52, 152, 219, 0.8)",borderWidth:1,yAxisID:"y2",order:2}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:{y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"積算花粉数"},beginAtZero:!0},y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"気温 (°C)"},grid:{drawOnChartArea:!1}},y2:{type:"linear",display:!0,position:"right",title:{display:!0,text:"降水量 (mm)"},grid:{drawOnChartArea:!1},beginAtZero:!0}}}}),s.classList.add("hidden"),r.style.opacity="1"};document.querySelector(".close-btn").addEventListener("click",()=>{document.getElementById("trend-modal").classList.remove("show")});window.onclick=function(e){e.target.classList.contains("modal")&&e.target.classList.remove("show")};function G(){if(!w)return;const t=w.getZoom()>=R.ZOOM_THRESHOLD;Object.values(T).forEach(n=>{t?(Z(n),n.openTooltip()):(n.closeTooltip(),n.unbindTooltip())})}document.addEventListener("DOMContentLoaded",()=>{if(typeof L>"u"||typeof CITIES>"u")return;const e=I();b.currentDate=e;const t=document.getElementById("date-picker");t.value=e,t.max=e;function n(){const a=I(),i=b.currentDate===a,c=document.querySelector(".toggle-group");if(c)if(i){c.classList.remove("disabled");const p=b.currentMode,d=document.querySelector(`input[name="display-mode"][value="${p}"]`);d&&(d.checked=!0)}else{c.classList.add("disabled");const p=document.getElementById("mode-daily");p&&(p.checked=!0)}}function o(a){if(!(a>e)&&(b.currentDate=a,t.value=a,n(),document.querySelectorAll(".btn-quick-date").forEach(i=>{const c=i.dataset.days,p=i.dataset.years;let d=new Date;c!==void 0?d.setDate(d.getDate()-parseInt(c)):p!==void 0&&d.setFullYear(d.getFullYear()-parseInt(p));const u=I(d);i.classList.toggle("active",u===a)}),O.clear(),Object.values(T).forEach(i=>{i.setStyle({fillColor:"#ccc"}),i.maxPollen=0,i.getTooltip()&&i.unbindTooltip()}),M().catch(i=>console.error(i)),k.updateRegisteredLocationUI(),typeof window.updateWeatherMarkers=="function"&&window.updateWeatherMarkers().catch(i=>console.error(i)),B)){const i=T[B.code];i&&i.isPopupOpen()&&q(B).catch(c=>console.error(c))}}t.addEventListener("change",a=>{o(a.target.value)}),document.getElementById("prev-day").addEventListener("click",()=>{const a=new Date(b.currentDate);a.setDate(a.getDate()-1),o(I(a))}),document.getElementById("next-day").addEventListener("click",()=>{const a=new Date(b.currentDate);a.setDate(a.getDate()+1);const i=I(a);i<=e&&o(i)}),document.querySelectorAll(".btn-quick-date").forEach(a=>{a.addEventListener("click",()=>{const i=a.dataset.days,c=a.dataset.years;let p=new Date;i!==void 0?p.setDate(p.getDate()-parseInt(i)):c!==void 0&&p.setFullYear(p.getFullYear()-parseInt(c)),o(I(p))})}),document.getElementsByName("display-mode").forEach(a=>{a.addEventListener("change",i=>{b.currentMode=i.target.value,O.clear(),Object.values(T).forEach(c=>{c.setStyle({fillColor:"#ccc"}),c.maxPollen=0,c.getTooltip()&&c.unbindTooltip()}),M().catch(c=>console.error(c))})}),document.querySelector('.btn-quick-date[data-days="0"]').classList.add("active");try{let a=[36.2048,138.2529],i=5;try{const d=localStorage.getItem("pollenMapState");if(d){const u=JSON.parse(d);u.lat&&u.lng&&u.zoom&&(a=[u.lat,u.lng],i=u.zoom)}}catch(d){console.error("Failed to load map state:",d)}w=L.map("map",{zoomControl:!1,minZoom:2,maxZoom:12}).setView(a,i),w.on("moveend",()=>{const d=w.getCenter(),u=w.getZoom(),f={lat:d.lat,lng:d.lng,zoom:u};localStorage.setItem("pollenMapState",JSON.stringify(f))}),L.control.zoom({position:"bottomright"}).addTo(w);const c={std:L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',opacity:.6}),relief:L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/hillshademap/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',opacity:.5})};c.std.addTo(w),document.querySelectorAll(".btn-map-type").forEach(d=>{d.addEventListener("click",()=>{const u=d.dataset.type;document.querySelectorAll(".btn-map-type").forEach(f=>f.classList.remove("active")),d.classList.add("active"),Object.values(c).forEach(f=>w.removeLayer(f)),c[u].addTo(w)})});const p=Q(()=>{M().catch(d=>console.error(d)),G()},500);w.on("zoomend",p),w.on("moveend",p),w.on("popupopen",()=>{const d=document.getElementById("crosshair");d&&(d.style.opacity="0")}),w.on("popupclose",()=>{const d=document.getElementById("crosshair");d&&(d.style.opacity="1")}),X()}catch(a){console.error("Initialization error:",a)}const s=document.getElementById("panel-toggle"),g=document.querySelector(".side-panel"),m=document.querySelector(".app-header");s&&g&&(s.addEventListener("click",()=>{g.classList.toggle("collapsed");const a=g.classList.contains("collapsed");s.title=a?"パネルを開く":"パネルを閉じる",window.innerWidth<=600&&m&&(a?(m.style.transform="translateX(-100%)",m.style.opacity="0",m.style.pointerEvents="none"):(m.style.transform="",m.style.opacity="",m.style.pointerEvents="")),setTimeout(()=>{M().catch(i=>console.error(i))},300)}),window.innerWidth<=600&&(g.classList.add("collapsed"),s.title="パネルを開く",m&&(m.style.transform="translateX(-100%)",m.style.opacity="0",m.style.pointerEvents="none"))),k.init()});const k={settingsKey:"pollen_notification_settings",checkInterval:900*1e3,timerId:null,init(){this.registerServiceWorker(),this.setupEventListeners(),this.startMonitoring(),this.updateRegisteredLocationUI(),this.unlockAudio()},unlockAudio(){const e=()=>{this.playNotificationSound(!0),window.removeEventListener("click",e),window.removeEventListener("touchstart",e),console.log("Audio unlocked")};window.addEventListener("click",e),window.addEventListener("touchstart",e)},setupEventListeners(){const e=document.getElementById("notification-modal"),t=document.getElementById("notification-close-btn"),n=document.getElementById("btn-save-notification"),o=document.getElementById("btn-test-notification"),r=document.getElementById("btn-clear-notification"),s=document.getElementById("guide-modal"),g=document.getElementById("guide-close-btn"),m=document.getElementById("btn-open-guide");t.onclick=()=>e.classList.remove("show"),g&&(g.onclick=()=>s.classList.remove("show")),m&&(m.onclick=()=>s.classList.add("show")),window.addEventListener("click",c=>{c.target===e&&e.classList.remove("show"),c.target===s&&s.classList.remove("show")}),n&&n.addEventListener("click",()=>this.saveSettings()),o&&o.addEventListener("click",()=>{this.testNotification()}),r&&r.addEventListener("click",()=>this.clearSettings());const a=document.getElementById("btn-jump-to-registered"),i=document.getElementById("btn-edit-registered");a&&a.addEventListener("click",()=>this.jumpToRegisteredLocation()),i&&i.addEventListener("click",()=>{const c=k.getSettings();c&&k.openSettings(c.cityCode,c.cityName)})},openSettings(e,t){console.log("Opening settings for:",t,e);const n=document.getElementById("notification-modal"),o=document.getElementById("notification-target-city"),r=document.getElementById("threshold-hourly"),s=document.getElementById("threshold-daily"),g=document.getElementById("enable-sound"),m=document.getElementById("enable-voice"),a=document.getElementById("btn-clear-notification"),i=this.getSettings();if(i&&i.cityCode&&i.cityCode!==e&&!confirm(`現在「${i.cityName}」が登録されています。
「${t}」に変更しますか？

※1ユーザーにつき1か所のみ登録できます。`))return;o.textContent=t,o.dataset.code=e,i&&i.cityCode===e?(r.value=i.thresholdHourly,s.value=i.thresholdDaily,g.checked=i.enableSound!==!1,m.checked=i.enableVoice!==!1,a.classList.remove("hidden")):(r.value=30,s.value=150,g.checked=!0,m.checked=!0,a.classList.add("hidden"));const c=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,p=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone,d=typeof Notification<"u";let u="";c?p?u="※iPhone（ホーム画面起動中）: 通知が届かない場合は、本体の「設定 > 通知 > 花粉Radar」を確認してください。":u="【重要】iPhoneでは、ブラウザを閉じている状態で通知を受け取るには「ホーム画面に追加」してアプリとして起動する必要があります。":d||(u="※お使いのブラウザはシステム通知に対応していません。アプリを開いている間のみアラートが表示されます。");const f=document.getElementById("notification-compatibility-warning");f&&(f.textContent=u,f.classList.toggle("hidden",!u),c&&!p?(f.style.color="#e11d48",f.style.backgroundColor="#fff1f2",f.style.borderColor="#fda4af"):(f.style.color="",f.style.backgroundColor="",f.style.borderColor="")),n.classList.add("show")},getSettings(){const e=localStorage.getItem(this.settingsKey);return e?JSON.parse(e):null},async saveSettings(){const e=document.getElementById("notification-target-city"),t=document.getElementById("threshold-hourly"),n=document.getElementById("threshold-daily"),o=document.getElementById("enable-sound"),r=document.getElementById("enable-voice"),s=e.dataset.code,g=e.textContent,m=parseInt(t.value,10),a=parseInt(n.value,10),i=o.checked,c=r.checked;if(!s)return;if(typeof Notification<"u")if(Notification.permission==="default")try{await Notification.requestPermission()!=="granted"&&console.log("Notification permission denied")}catch(u){console.error("Error requesting notification permission:",u)}else Notification.permission==="denied"&&alert("通知がブロックされています。ブラウザの設定から通知を許可してください。システム通知以外の機能は利用可能です。");const p={cityCode:s,cityName:g,thresholdHourly:m,thresholdDaily:a,enableSound:i,enableVoice:c,enableVibration:!1,lastNotified:0};localStorage.setItem(this.settingsKey,JSON.stringify(p)),await this.subscribeUser(p)?this.showToast(`通知設定を保存しました
(アプリを閉じても通知が届きます)`):(this.showToast(`設定は保存されましたが、
バックグラウンド通知の登録に失敗しました`,"warning",1e4),alert(`【注意】
設定は保存されましたが、プッシュ通知の登録に失敗しました。
・アプリを開いている間のみ通知されます。
・ブラウザの通知設定やプライベートモードでないか確認してください。`)),document.getElementById("notification-modal").classList.remove("show"),this.updateRegisteredLocationUI(),this.startMonitoring(),this.checkPollenLevels()},async clearSettings(){confirm("通知設定を解除しますか？")&&(await this.unsubscribeUser(),localStorage.removeItem(this.settingsKey),document.getElementById("notification-modal").classList.remove("show"),this.showToast("通知設定を解除しました"),this.updateRegisteredLocationUI(),this.stopMonitoring())},async testNotification(){console.log("Testing notification...");let e="granted";if(typeof Notification<"u"?(console.log("Current permission:",Notification.permission),e=await Notification.requestPermission(),console.log("Permission after request:",e)):console.log("Notification API not supported"),e==="granted"){console.log("Creating notification...");const t=this.getSettings(),n=t?t.cityName:"テスト地点",o=document.getElementById("enable-sound"),r=document.getElementById("enable-voice"),s=o?o.checked:!0,g=r?r.checked:!0;if(this.playNotificationSound(!1,s,g),this.vibrate(),this.showToast(`${n}の花粉の量が1時間あたり35個を観測しました。`,"warning",1e4),typeof Notification<"u"&&e==="granted")try{const a=await(await navigator.serviceWorker.ready).pushManager.getSubscription();if(a){console.log("Pushing test to backend worker:",F),this.showToast("10秒後にバックグラウンド通知を送信します。その間にブラウザを閉じたりしてテストしてください。","info",1e4);const i=await fetch(`${F}/api/test-push`,{method:"POST",body:JSON.stringify({subscription:a}),headers:{"Content-Type":"application/json"}}),c=await i.json();i.ok&&c.success?console.log("Backend test push request accepted"):(console.error("Backend test push failed:",c.error||i.statusText),alert("クラウド通知の送信予約に失敗しました。"))}else console.warn("No active push subscription found for backend test"),alert("通知の登録が見つかりません。「保存」ボタンを押して登録を完了させてください。")}catch(m){console.error("Notification error:",m),console.log("Note: Backend test push failed")}}else console.log("Permission denied"),alert("通知の許可が得られませんでした。")},playNotificationSound(e=!1){const t="notification.mp3",n=new Audio(t);n.volume=e?0:1,n.play().catch(()=>{try{const o=new(window.AudioContext||window.webkitAudioContext),r=o.createOscillator(),s=o.createGain();r.connect(s),s.connect(o.destination),r.frequency.value=800,r.type="sine",s.gain.setValueAtTime(0,o.currentTime),s.gain.linearRampToValueAtTime(.3,o.currentTime+.1),s.gain.linearRampToValueAtTime(0,o.currentTime+.4),r.start(o.currentTime),r.stop(o.currentTime+.4),console.log("Notification beep played")}catch(o){console.error("Error playing sound:",o)}})},speakMessage(e){try{if("speechSynthesis"in window){window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(e);t.lang="ja-JP",t.rate=1,t.pitch=1,t.volume=1;const o=window.speechSynthesis.getVoices().find(r=>r.lang.startsWith("ja"));o&&(t.voice=o,console.log("Using voice:",o.name)),console.log("Speaking:",e),window.speechSynthesis.speak(t)}else console.log("Speech synthesis not supported")}catch(t){console.error("Error speaking message:",t)}},vibrate(){const e=[300,100,300];if(navigator.vibrate){const t=navigator.vibrate(e);console.log("Vibration triggered, result:",t),console.log("Vibration pattern:",e)}else console.log("Vibration API not supported")},playNotificationSound(e=!1,t=null,n=null){if(!e){if(t===null||n===null){const o=this.getSettings();if(!o)return;t===null&&(t=o.enableSound!==!1),n===null&&(n=o.enableVoice!==!1)}t&&this.playAlertSound(),n&&setTimeout(()=>{this.playVoiceNotification()},800)}},playAlertSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.currentTime,n=e.createOscillator(),o=e.createGain();n.connect(o),o.connect(e.destination),n.frequency.value=880,n.type="sine",o.gain.setValueAtTime(.3,t),o.gain.exponentialRampToValueAtTime(.01,t+.2),n.start(t),n.stop(t+.2);const r=e.createOscillator(),s=e.createGain();r.connect(s),s.connect(e.destination),r.frequency.value=660,r.type="sine",s.gain.setValueAtTime(0,t+.15),s.gain.setValueAtTime(.3,t+.15),s.gain.exponentialRampToValueAtTime(.01,t+.5),r.start(t+.15),r.stop(t+.5)}catch(e){console.error("Error playing alert sound:",e)}},async registerServiceWorker(){if("serviceWorker"in navigator&&"PushManager"in window)try{const e=await navigator.serviceWorker.register("./sw.js");return console.log("Service Worker registered:",e),e}catch(e){return console.error("Service Worker registration failed:",e),null}else return console.warn("Push notifications not supported"),null},urlBase64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(n),r=new Uint8Array(o.length);for(let s=0;s<o.length;++s)r[s]=o.charCodeAt(s);return r},async getVapidKey(){try{const e=await fetch(`${F}/api/vapid-key`);if(!e.ok)throw new Error("Failed to get VAPID key");const t=await e.json();return t.publicKey?t.publicKey.trim():null}catch(e){return console.error("Error fetching VAPID key:",e),null}},async subscribeUser(e){const t=await navigator.serviceWorker.ready;if(!t)return!1;try{const n=await this.getVapidKey();if(!n)return console.error("No VAPID key available"),!1;const o=this.urlBase64ToUint8Array(n),r=await t.pushManager.getSubscription();r&&(console.log("Unsubscribing existing subscription first..."),await r.unsubscribe());const s=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:o});return console.log("User is subscribed:",s),await fetch(`${F}/api/subscribe`,{method:"POST",body:JSON.stringify({subscription:s,settings:e}),headers:{"Content-Type":"application/json"}}),!0}catch(n){return console.error("Failed to subscribe the user: ",n),!1}},async unsubscribeUser(){try{const t=await(await navigator.serviceWorker.ready).pushManager.getSubscription();t&&(await fetch(`${F}/api/unsubscribe`,{method:"POST",body:JSON.stringify({endpoint:t.endpoint}),headers:{"Content-Type":"application/json"}}),await t.unsubscribe(),console.log("User is unsubscribed."))}catch(e){console.error("Error unsubscribing",e)}},playVoiceNotification(){try{const e=new Audio("notification.mp3");e.volume=.7,e.play().catch(t=>{console.error("Error playing voice notification:",t)})}catch(e){console.error("Error creating audio:",e)}},startMonitoring(){this.stopMonitoring();const e=this.getSettings();e&&console.log(`Monitoring started for ${e.cityName}`)},stopMonitoring(){this.timerId&&(clearInterval(this.timerId),this.timerId=null)},async checkPollenLevels(){const e=this.getSettings();if(!e)return;const t=new Date,n=I(),o=n.replace(/-/g,""),r=o;console.log("Checking pollen levels:",{start:o,end:r,cityCode:e.cityCode});const s=await V(e.cityCode,o,r);if(!s||s.length===0){console.log("No data returned from API");return}const g=s.filter(u=>u.date.toISOString().split("T")[0]===n&&u.pollen>=0);if(g.length===0)return;const m=g[g.length-1].pollen,a=g.reduce((u,f)=>u+f.pollen,0);let i=!1,c=[];const p=m>=e.thresholdHourly,d=a>=e.thresholdDaily;if(p&&(i=!0,c.push(`${e.cityName}の花粉の量が1時間あたり${m}個を観測しました。`)),d){const u=e.lastDailyAlert||"";(u!==n||p)&&(i=!0,c.push(`${e.cityName}の花粉の量が累積値${a}個になりました。`),u!==n&&(e.lastDailyAlert=n,localStorage.setItem(this.settingsKey,JSON.stringify(e))))}if(i){e.enableSound!==!1&&this.playNotificationSound(),e.enableVibration!==!1&&this.vibrate();const u=c.join(`
`);if(this.showToast(u,"warning",1e4),typeof Notification<"u"&&Notification.permission==="granted")try{new Notification(`【花粉注意】${e.cityName}`,{body:u,silent:!0})}catch(f){console.error("System notification failed:",f)}e.lastNotified=t.getTime(),localStorage.setItem(this.settingsKey,JSON.stringify(e))}},showToast(e,t="info",n=3e3){const o=document.createElement("div");o.className=`toast toast-${t}`;const r=document.createElement("i");r.className=`fas ${t==="warning"?"fa-exclamation-triangle":"fa-info-circle"}`,o.appendChild(r),o.appendChild(document.createTextNode(" ")),o.appendChild(document.createTextNode(e)),document.body.appendChild(o),setTimeout(()=>{o.classList.add("fade-out"),o.addEventListener("animationend",()=>o.remove())},n)},async updateRegisteredLocationUI(){const e=document.getElementById("registered-location-section"),t=document.getElementById("registered-city-name"),n=document.getElementById("registered-pollen-dot"),o=document.getElementById("registered-pollen-count"),r=this.getSettings();if(r&&r.cityCode){t.textContent=r.cityName,e.classList.remove("hidden");const s=T[r.cityCode];if(s&&s.maxPollen!==void 0){const g=A(s.maxPollen,s.isPast);n.style.backgroundColor=g,n.classList.remove("hidden"),o.textContent=s.maxPollen,o.classList.remove("hidden")}else try{const g=I(),m=b.currentDate===g,a=b.currentDate.replace(/-/g,""),i=new Date(b.currentDate);i.setDate(i.getDate()+1);let c=i.toISOString().split("T")[0].replace(/-/g,"");const p=g.replace(/-/g,"");c>p&&(c=p);const d=await V(r.cityCode,a,c);if(d&&d.length>0){let u=0;if(m){const S=new Date,D=d.filter(l=>l.date<=S&&l.pollen!==null&&l.pollen>=0),h=D.length>0?D[D.length-1]:null;u=h?h.pollen:0}else u=d.filter(S=>S.dateKey===b.currentDate).reduce((S,D)=>S+(D.pollen>0?D.pollen:0),0);const f=A(u,!m);n.style.backgroundColor=f,n.classList.remove("hidden"),o.textContent=u,o.classList.remove("hidden")}else n.classList.add("hidden"),o.classList.add("hidden")}catch(g){console.error("Error updating registered location UI:",g),n.classList.add("hidden"),o.classList.add("hidden")}}else e.classList.add("hidden")},jumpToRegisteredLocation(){const e=this.getSettings();if(!e||!e.cityCode)return;const t=CITIES.find(n=>n.code===e.cityCode);t&&w&&(w.setView([t.lat,t.lng],10),setTimeout(()=>{const n=T[t.code];n&&n.openPopup()},500))}},J={updateTimer:null,nextUpdateTime:null,lastUpdateTime:null,COOLDOWN_PERIOD:300*1e3,init(){this.scheduleNextUpdate()},calculateNextUpdateTime(){const e=new Date,t=new Date(e),n=10+Math.floor(Math.random()*4),o=Math.floor(Math.random()*60);return t.setMinutes(n,o,0),e>=t&&t.setHours(t.getHours()+1),t},scheduleNextUpdate(){this.updateTimer&&clearTimeout(this.updateTimer),this.nextUpdateTime=this.calculateNextUpdateTime();const e=new Date,t=this.nextUpdateTime-e;console.log(`[AutoUpdate] Next update scheduled at ${this.nextUpdateTime.toLocaleTimeString("ja-JP")} (in ${Math.round(t/1e3/60)} minutes)`),this.updateTimer=setTimeout(()=>{this.performUpdate(),this.scheduleNextUpdate()},t)},async performUpdate(){console.log("[AutoUpdate] Starting automatic update...",{currentDate:b.currentDate});const e=new Date;if(this.lastUpdateTime){const t=e-this.lastUpdateTime;if(t<this.COOLDOWN_PERIOD){const n=Math.ceil((this.COOLDOWN_PERIOD-t)/1e3/60);console.log(`[AutoUpdate] Skipping update - cooldown period active (${n} minutes remaining)`);return}}this.lastUpdateTime=e;try{b.cache={},O.clear(),Object.values(T).forEach(n=>{n.setStyle({fillColor:"#ccc"}),n.maxPollen=0,n.isPast=!1,n.getTooltip()&&n.unbindTooltip()});const t=I();if(b.currentDate===t){if(await M(),G(),typeof window.updateWeatherMarkers=="function"&&await window.updateWeatherMarkers(),B){const n=T[B.code];n&&n.isPopupOpen()&&await q(B,n)}console.log("[AutoUpdate] Automatic update completed successfully"),typeof k<"u"&&k.checkPollenLevels&&await k.checkPollenLevels()}else console.log("[AutoUpdate] Not today, skipping data refresh")}catch(t){console.error("[AutoUpdate] Automatic update failed:",t)}},destroy(){this.updateTimer&&clearTimeout(this.updateTimer)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{J.init()},1e3)}):setTimeout(()=>{J.init()},1e3);
