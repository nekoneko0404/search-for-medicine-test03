import{n as d}from"./utils-cz7vvGbo.js";const S="1ZyjtfiRjGoV9xHSA5Go4rJZr281gqfMFW883Y7s9mQU",I="1lTHHbUj6ySAgtum8zJrHjWAxYnbOO9r8H8Cnu-Y0TnA";function N(a){return new Promise((t,o)=>{if(document.querySelector(`script[src="${a}"]`)){t();return}const e=document.createElement("script");e.src=a,e.onload=()=>t(),e.onerror=()=>o(new Error(`Script load error for ${a}`)),document.head.appendChild(e)})}function D(a){if(typeof a!="string"||a.trim()==="")return null;let t=new Date(a);if(!isNaN(t.getTime()))return t;if(a.startsWith("Date(")){const e=a.match(/\d+/g);if(e&&e.length>=3)return new Date(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]))}const o=a.match(/\d+/g);if(o&&o.length>=3){let e,c,s;const r=o.findIndex(i=>parseInt(i)>1900);if(r!==-1){e=parseInt(o[r]);const i=o.filter((n,l)=>l!==r);if(i.length>=2&&(c=parseInt(i[0])-1,s=parseInt(i[1]),t=new Date(e,c,s),!isNaN(t.getTime())))return t}}return null}function j(a){const t=[];let o="",e=!1;for(let c=0;c<a.length;c++){const s=a[c];s==='"'?e&&a[c+1]==='"'?(o+='"',c++):e=!e:s===","&&!e?(t.push(o),o=""):o+=s}return t.push(o),t}function b(a,t){t&&t("データを処理中...",75);const o=a.trim().split(`
`);if(o.length<2)return[];const e=[];for(let c=0;c<o.length;c++){const s=o[c].trim();if(!s)continue;const r=j(s);if(r.length<5)continue;const n=r.length===14?{ingredient:0,yj:1,product:2,maker:3,cat:4,basic:5,status:6,reason:7,prospect:8,expDate:9,vol:10,update:11,trend:12,meta:13}:{ingredient:2,yj:4,product:5,maker:6,cat:7,basic:8,status:11,reason:13,prospect:14,expDate:15,vol:16,update:19,trend:22,meta:23},l=r[n.product]||"",u=r[n.update]||"";if(l.includes("品名")||u.includes("更新有無")||u.includes("当該品目")||!l&&!r[n.ingredient])continue;let f=[],h="",y="";try{let p=r[n.trend]||"",m=r[n.meta]||"";if(m.length>1&&m.startsWith("{")){const x=m.replace(/""/g,'"'),w=JSON.parse(x);w&&Array.isArray(w.updated_cols)&&(f=w.updated_cols)}else y=m;p==="▲"||p==="⤴️"?h="⤴️":(p==="▼"||p==="⤵️")&&(h="⤵️")}catch{}e.push({productName:r[n.product],normalizedProductName:d(r[n.product]),ingredientName:r[n.ingredient],normalizedIngredientName:d(r[n.ingredient]),manufacturer:r[n.maker],normalizedManufacturer:d(r[n.maker]),shipmentStatus:r[n.status],reasonForLimitation:r[n.reason],resolutionProspect:r[n.prospect],expectedDate:r[n.expDate],expectedDateObj:D(r[n.expDate]),shipmentVolumeStatus:r[n.vol],yjCode:r[n.yj],productCategory:r[n.cat],isBasicDrug:r[n.basic],updateDateObj:D(r[n.update]),updatedCells:f,shippingStatusTrend:h,changedPart:y})}return e}async function X(){console.log("Fetching manufacturer data...");try{await N("https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js")}catch(t){return console.error(t),{}}const a=`https://docs.google.com/spreadsheets/d/${I}/export?format=xlsx`;try{const t=await fetch(a,{cache:"no-cache"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);if(typeof window.XLSX>"u")throw new Error("XLSX library not loaded");const o=await t.arrayBuffer(),e=window.XLSX.read(o,{type:"array"}),c=e.Sheets[e.SheetNames[0]],s=window.XLSX.utils.decode_range(c["!ref"]),r={};for(let i=s.s.r+1;i<=s.e.r;++i){const n=c[window.XLSX.utils.encode_cell({r:i,c:0})],l=c[window.XLSX.utils.encode_cell({r:i,c:1})],u=n?window.XLSX.utils.format_cell(n):null,f=l?l.l?l.l.Target:window.XLSX.utils.format_cell(l):null;u&&f&&(r[u.trim()]=f.trim())}return console.log("Manufacturer data loaded successfully."),r}catch(t){return console.error(`メーカーデータの取得に失敗しました: ${a} ${t}`),{}}}async function g(a){console.log("Fetching CSV data from Google Drive..."),a&&a("Google Driveからデータを読み込み中...",0);const o=`https://docs.google.com/spreadsheets/d/${S}/gviz/tq?tqx=out:csv&t=${new Date().getTime()}&tq=${encodeURIComponent("SELECT "+"C,E,F,G,H,I,L,N,O,P,Q,T,W,X")}`;try{a&&a("データをダウンロード中...",50);const e=await fetch(o,{cache:"no-cache"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const c=await e.text(),s=b(c,a);if(s.length>0&&window.localforage){const r={timestamp:new Date().getTime(),data:s};await window.localforage.setItem("excelCache",r)}return console.log(`Data loaded successfully. Rows: ${s.length}`),a&&a("データ読み込み完了！",100),{data:s,date:"Google Drive"}}catch(e){throw console.error(`データ取得失敗: ${o} ${e}`),e}}async function C(a){if(console.log("共通データローダーを開始します。"),!window.localforage)return console.warn("localforage is not available. Fetching from network directly."),await g(a);try{const t=await window.localforage.getItem("excelCache"),o=3600*1e3;return t&&new Date().getTime()-t.timestamp<o?(console.log("キャッシュからデータを読み込みました。"),Array.isArray(t.data)&&t.data.forEach(e=>{e.updateDateObj&&typeof e.updateDateObj=="string"&&(e.updateDateObj=new Date(e.updateDateObj)),e.expectedDateObj&&typeof e.expectedDateObj=="string"&&(e.expectedDateObj=new Date(e.expectedDateObj)),!e.normalizedProductName&&e.productName&&(e.normalizedProductName=d(e.productName)),!e.normalizedIngredientName&&e.ingredientName&&(e.normalizedIngredientName=d(e.ingredientName)),!e.normalizedManufacturer&&e.manufacturer&&(e.normalizedManufacturer=d(e.manufacturer))}),a&&a("キャッシュから読み込み完了",100),{data:t.data||[],date:"キャッシュ"}):(console.log(t?"キャッシュが古いため、ネットワークから取得します。":"キャッシュが見つからないため、ネットワークから取得します。"),await g(a))}catch(t){return console.error("キャッシュからの読み込みに失敗しました。ネットワークから取得します。",t),await g(a)}}async function O(a){try{return window.localforage&&(await window.localforage.removeItem("excelCache"),console.log("キャッシュを削除しました。")),await C(a)}catch(t){throw console.error("Failed to clear cache",t),new Error(`キャッシュのクリアに失敗しました: ${t.message}`)}}export{O as c,X as f,C as l};
