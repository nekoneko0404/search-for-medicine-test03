import{n as l}from"./utils-cz7vvGbo.js";const I="1ZyjtfiRjGoV9xHSA5Go4rJZr281gqfMFW883Y7s9mQU";function y(a){if(typeof a!="string"||a.trim()==="")return null;let n=new Date(a);if(!isNaN(n.getTime()))return n;if(a.startsWith("Date(")){const e=a.match(/\d+/g);if(e&&e.length>=3)return new Date(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]))}const o=a.match(/\d+/g);if(o&&o.length>=3){let e,c,i;const t=o.findIndex(s=>parseInt(s)>1900);if(t!==-1){e=parseInt(o[t]);const s=o.filter((r,u)=>u!==t);if(s.length>=2&&(c=parseInt(s[0])-1,i=parseInt(s[1]),n=new Date(e,c,i),!isNaN(n.getTime())))return n}}return null}function N(a){const n=[];let o="",e=!1;for(let c=0;c<a.length;c++){const i=a[c];i==='"'?e&&a[c+1]==='"'?(o+='"',c++):e=!e:i===","&&!e?(n.push(o),o=""):o+=i}return n.push(o),n}function j(a,n){n&&n("データを処理中...",75);const o=a.trim().split(`
`);if(o.length<2)return[];const e=[];for(let c=0;c<o.length;c++){const i=o[c].trim();if(!i)continue;const t=N(i);if(t.length<5)continue;const r=t.length===14?{ingredient:0,yj:1,product:2,maker:3,cat:4,basic:5,status:6,reason:7,prospect:8,expDate:9,vol:10,update:11,trend:12,meta:13}:{ingredient:2,yj:4,product:5,maker:6,cat:7,basic:8,status:11,reason:13,prospect:14,expDate:15,vol:16,update:19,trend:22,meta:23},u=t[r.product]||"",h=t[r.update]||"";if(u.includes("品名")||h.includes("更新有無")||h.includes("当該品目")||!u&&!t[r.ingredient])continue;let w=[],f="",D="";try{let d=t[r.trend]||"",p=t[r.meta]||"";if(p.length>1&&p.startsWith("{")){const x=p.replace(/""/g,'"'),g=JSON.parse(x);g&&Array.isArray(g.updated_cols)&&(w=g.updated_cols)}else D=p;d==="▲"||d==="⤴️"?f="⤴️":(d==="▼"||d==="⤵️")&&(f="⤵️")}catch{}e.push({productName:t[r.product],normalizedProductName:l(t[r.product]),ingredientName:t[r.ingredient],normalizedIngredientName:l(t[r.ingredient]),manufacturer:t[r.maker],normalizedManufacturer:l(t[r.maker]),shipmentStatus:t[r.status],reasonForLimitation:t[r.reason],resolutionProspect:t[r.prospect],expectedDate:t[r.expDate],expectedDateObj:y(t[r.expDate]),shipmentVolumeStatus:t[r.vol],yjCode:t[r.yj],productCategory:t[r.cat],isBasicDrug:t[r.basic],updateDateObj:y(t[r.update]),updatedCells:w,shippingStatusTrend:f,changedPart:D})}return e}async function m(a){console.log("Fetching CSV data from Google Drive..."),a&&a("Google Driveからデータを読み込み中...",0);const o=`https://docs.google.com/spreadsheets/d/${I}/gviz/tq?tqx=out:csv&t=${new Date().getTime()}&tq=${encodeURIComponent("SELECT "+"C,E,F,G,H,I,L,N,O,P,Q,T,W,X")}`;try{a&&a("データをダウンロード中...",50);const e=await fetch(o,{cache:"no-cache"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const c=await e.text(),i=j(c,a);if(i.length>0&&window.localforage){const t={timestamp:new Date().getTime(),data:i};await window.localforage.setItem("excelCache",t)}return console.log(`Data loaded successfully. Rows: ${i.length}`),a&&a("データ読み込み完了！",100),{data:i,date:"Google Drive"}}catch(e){throw console.error(`データ取得失敗: ${o} ${e}`),e}}async function b(a){if(console.log("共通データローダーを開始します。"),!window.localforage)return console.warn("localforage is not available. Fetching from network directly."),await m(a);try{const n=await window.localforage.getItem("excelCache"),o=3600*1e3;return n&&new Date().getTime()-n.timestamp<o?(console.log("キャッシュからデータを読み込みました。"),Array.isArray(n.data)&&n.data.forEach(e=>{e.updateDateObj&&typeof e.updateDateObj=="string"&&(e.updateDateObj=new Date(e.updateDateObj)),e.expectedDateObj&&typeof e.expectedDateObj=="string"&&(e.expectedDateObj=new Date(e.expectedDateObj)),!e.normalizedProductName&&e.productName&&(e.normalizedProductName=l(e.productName)),!e.normalizedIngredientName&&e.ingredientName&&(e.normalizedIngredientName=l(e.ingredientName)),!e.normalizedManufacturer&&e.manufacturer&&(e.normalizedManufacturer=l(e.manufacturer))}),a&&a("キャッシュから読み込み完了",100),{data:n.data||[],date:"キャッシュ"}):(console.log(n?"キャッシュが古いため、ネットワークから取得します。":"キャッシュが見つからないため、ネットワークから取得します。"),await m(a))}catch(n){return console.error("キャッシュからの読み込みに失敗しました。ネットワークから取得します。",n),await m(a)}}async function O(a){try{return window.localforage&&(await window.localforage.removeItem("excelCache"),console.log("キャッシュを削除しました。")),await b(a)}catch(n){throw console.error("Failed to clear cache",n),new Error(`キャッシュのクリアに失敗しました: ${n.message}`)}}export{O as c,b as l};
