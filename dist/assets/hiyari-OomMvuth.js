import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{n as b}from"./utils-cz7vvGbo.js";import{s as x}from"./ui-C1FH7vrA.js";import"./MainHeader-Cz0INnUv.js";import{t as F}from"./typing-animation-B3fvp7eE.js";const P="/hiyari-proxy/proxy",U=30,e={searchInput:null,searchBtn:null,filterInput:null,randomBtn:null,resultsContainer:null,loadingIndicator:null,errorMsg:null,mainHeader:null,mainFooter:null,reloadButton:null,usageGuide:null,shareBtn:null};let p=[],T=0;function $(){e.searchInput=document.getElementById("search-input"),e.searchBtn=document.getElementById("search-btn"),e.filterInput=document.getElementById("filter-input"),e.randomBtn=document.getElementById("random-btn"),e.resultsContainer=document.getElementById("results-container"),e.loadingIndicator=document.getElementById("loading"),e.errorMsg=document.getElementById("error-msg"),e.mainHeader=document.getElementById("mainHeader"),e.mainFooter=document.getElementById("mainFooter"),e.reloadButton=document.getElementById("reload-button"),e.usageGuide=document.getElementById("usage-guide"),e.shareBtn=document.getElementById("share-btn")}function L(t){t?e.loadingIndicator.classList.remove("hidden"):e.loadingIndicator.classList.add("hidden")}function H(t){e.errorMsg.textContent=t,e.errorMsg.classList.remove("hidden")}function w(){e.errorMsg.classList.add("hidden")}function k(t,n,a=0){const r=new URLSearchParams;r.append("count","30"),r.append("start",a.toString()),r.append("order","2");const l=b(t).replace(/ー/g," ").trim(),u=b(n).replace(/ー/g," ").trim();if(l&&!u)r.append("item","DATMEDNAME"),r.append("item","DATGENERIC"),r.append("word",l),r.append("condition","any");else{const d=[l,u].filter(Boolean).join(" ");d&&(r.append("word",d),l&&u&&r.append("condition","all"))}return`${P}?${r.toString()}`}async function C(t=0){const n=e.searchInput.value.trim(),a=e.filterInput.value.trim();if(!n&&!a){e.resultsContainer.innerHTML="",w(),document.body.classList.remove("search-mode"),e.usageGuide&&e.usageGuide.classList.remove("hidden");return}const r=d=>{if(!d)return{include:[],exclude:[]};const c=d.split(/[\s　]+/).filter(i=>i.length>0),o=[],s=[];return c.forEach(i=>{i.startsWith("ー")&&i.length>1?s.push(b(i.substring(1))):o.push(b(i))}),{include:o,exclude:s}},l=r(n),u=r(a);L(!0),w(),t===0&&(e.resultsContainer.innerHTML="",p=[],T=0,e.usageGuide&&e.usageGuide.classList.add("hidden"));try{const d=l.include.join(" "),c=u.include.join(" "),o=k(d,c,t);console.log(`[Hiyari Debug] Fetching from: ${o}`);const s=await fetch(o);if(console.log(`[Hiyari Debug] Response status: ${s.status}`),!s.ok)throw new Error(`API Error: ${s.status}`);const i=await s.text();console.log(`[Hiyari Debug] Response length: ${i.length}`),console.log(`[Hiyari Debug] Response Start: ${i.substring(0,500)}`),console.log(`[Hiyari Debug] Response End: ${i.substring(i.length-200)}`);const m=new DOMParser().parseFromString(i,"application/xml");console.log(`[Hiyari Debug] Root Node: ${m.documentElement.nodeName}`);const f=m.querySelector("Error");if(f)throw new Error(`API Error: ${f.textContent}`);const E=m.querySelectorAll("PHARMACY_REPORT");if(console.log(`[Hiyari Debug] Reports found: ${E.length}`),E.length===0){if(t===0){const g=document.createElement("p");g.className="col-span-full text-center text-gray-500 py-8",g.textContent="該当する事例は見つかりませんでした。",e.resultsContainer.appendChild(g),document.body.classList.remove("search-mode")}else x("これ以上の事例はありません","info");return}const A=Array.from(E).map(G).filter(g=>{const M=(v,D)=>{const O=JSON.stringify(v),B=b(O),S=D.exclude.length===0||!D.exclude.some(I=>B.includes(I));return D.include.every(I=>B.includes(I))&&S};return M(g,l)&&M(g,u)});if(A.length===0){if(t===0){const g=document.createElement("p");g.className="col-span-full text-center text-gray-500 py-8",g.textContent="条件にヒットする事例はありませんでした。",e.resultsContainer.appendChild(g),document.body.classList.remove("search-mode")}else x("このページの事例は全てフィルタリングされました。","info");return}A.length>0?(p=[...p,...A],R(A),T+=A.length,document.body.classList.add("search-mode"),X()):t===0||x("このページの事例は全てフィルタリングされました。","info")}catch(d){console.error("Fetching incidents failed:",d),H(`データ取得に失敗しました: ${d.message}`)}finally{L(!1)}}function G(t){const n=o=>{const s=t.querySelector(o);return s?s.textContent.trim():"記載なし"},a={"01":"調剤に関するヒヤリ・ハット事例","02":"疑義照会や処方医への情報提供に関する事例","03":"特定保険医療材料等に関する事例","04":"一般用医薬品等の販売に関する事例"},r={"01":"レセコンの入力間違い","02":"薬剤取り違え（異なる成分）","03":"薬剤取り違え（同成分）","04":"数量間違い","05":"剤形間違い","06":"規格間違い","07":"用法間違い","08":"患者間違い","09":"その他"},l={"01":"処方箋やその記載のされ方の要因","02":"調剤方法の要因","03":"鑑査方法の要因","04":"患者の要因","05":"医薬品の要因","06":"情報システムの要因","07":"その他の要因"},u={100101:"判断誤り",100102:"手順不遵守",100103:"スタッフ間のコミュニケーション不足・齟齬",100104:"患者とのコミュニケーション不足・齟齬",100199:"その他",110101:"知識不足",110102:"技術・手技が未熟",110103:"慣れ・慢心",110104:"焦り・慌て",110105:"疲労・体調不良・身体的不調",110106:"心配ごと等心理的状態",110199:"その他",120101:"医薬品の名称類似",120102:"医薬品や包装の外観類似",120103:"医薬品包装表示・添付文書の要因",120104:"処方箋やその記載のされ方の要因",120105:"コンピューターシステムの使いにくさ・不具合",120106:"調剤設備・調剤機器の使いにくさ・不具合",120107:"薬剤服用歴などの記録の不備",120108:"調剤室の環境的な要因",120109:"調剤室以外の環境的な要因",120199:"その他",130101:"繁忙であった",130102:"標榜する営業時間外であった",130103:"普段とは異なる業務状況だった",130199:"その他",140101:"教育訓練のなされ方",140102:"設備機器等の管理",140103:"薬局内のルールや管理の体制・仕方",140104:"薬局内の風土・雰囲気",140199:"その他",150101:"患者や家族の不注意",150102:"患者や家族の理解力・誤解",150103:"患者や家族のコンプライアンス・協力態度",150199:"その他"},d={160101:"患者とのコミュニケーション不足・齟齬",160102:"カルテ記載の不備",160103:"コンピューターシステムの使いにくさ・不具合",160104:"連携不足",160105:"知識不足",160106:"判断誤り",160107:"処方内容の確認不足",160199:"その他",170101:"医薬品の名称類似",170102:"患者や家族の要因",170199:"その他"},c=o=>{const s=t.querySelectorAll(o);if(s.length===0)return"N/A";let i=[];return s.forEach(y=>{const m=y.getAttribute("CODE"),f=y.textContent;let E=f.replace(/\s*\(コード:\s*[^)]+\)/g,"").trim(),h="";o==="DATSUMMARY"?h=a[m]||"不明な事例区分":o==="DATMONTH"?h={"01":"1月","02":"2月","03":"3月","04":"4月","05":"5月","06":"6月","07":"7月","08":"8月","09":"9月",10:"10月",11:"11月",12:"12月"}[m]||`不明な月 (${m})`:o==="DATCONTENTTEXT"?h=r[m]||"":o==="DATFACTORTEXT"?h=l[m]||"":o==="DATFACTOR"?h=u[m]||"":o==="DATFACTORDOUBT"&&(h=d[m]||""),E=h,f&&f.trim()!==""&&h!==f.trim()&&o.includes("TEXT")&&(E=`${h} ${f.trim()}`),E&&i.push(E)}),i.join("<br>")||"N/A"};return{year:n("DATYEAR"),month:c("DATMONTH"),summary:c("DATSUMMARY"),content:c("DATCONTENTTEXT"),factor:c("DATFACTORTEXT"),factors:c("LSTFACTOR DATFACTOR"),factorDoubts:c("LSTFACTORDOUBT DATFACTORDOUBT"),improvement:n("DATIMPROVEMENTTEXT"),estimatedText:n("DATESTIMATEDTEXT"),effortText:n("DATEFFORTTEXT"),medNames:Array.from(t.querySelectorAll("DATMEDNAME")).map(o=>o.textContent.trim()).join(" "),genericNames:Array.from(t.querySelectorAll("DATGENERIC")).map(o=>o.textContent.trim()).join(" "),patientAge:n("DATPATIENTAGE")}}function N(){if(p.length-T>0){const n=p.slice(T,T+U);R(n),T+=n.length}else C(T)}function X(){let t=document.getElementById("load-more-btn");t||(t=document.createElement("button"),t.id="load-more-btn",t.className="col-span-full mx-auto bg-white text-indigo-600 border border-indigo-600 font-semibold rounded-lg px-6 py-2 hover:bg-indigo-50 transition-colors mt-4",t.textContent="さらに表示",t.addEventListener("click",N),e.resultsContainer.parentNode.appendChild(t)),t.classList.remove("hidden")}function R(t){if(t.length===0&&T===0){const n=document.createElement("p");n.className="col-span-full text-center text-gray-500 py-8",n.textContent="関連する事例は見つかりませんでした。",e.resultsContainer.appendChild(n);return}t.forEach(n=>{const a=document.createElement("div");a.className="bg-white rounded-xl shadow-lg border border-slate-200 p-4 transition-transform duration-200 hover:scale-[1.02]";const r=(c,o)=>{if(!o||o==="記載なし"||o==="N/A")return null;const s=document.createElement("p");s.className="text-sm text-gray-700 leading-relaxed mb-2";const i=document.createElement("strong");i.className="font-semibold text-indigo-600 border-b border-slate-300 pb-0.5 mb-1 inline-block",i.textContent=c,s.appendChild(i),s.appendChild(document.createElement("br"));const y=o.split("<br>");return y.forEach((m,f)=>{s.appendChild(document.createTextNode(m)),f<y.length-1&&s.appendChild(document.createElement("br"))}),s},l=document.createElement("h2");l.className="text-lg font-bold text-indigo-700 border-b-2 border-slate-200 pb-2 mb-3",l.textContent=n.summary,a.appendChild(l);const u=document.createElement("p");u.className="text-sm text-gray-500 text-right mb-3",u.textContent=`発生年月: ${n.year}年${n.month}`,a.appendChild(u);const d=r("事例の詳細:",n.content);if(d&&a.appendChild(d),n.summary.includes("疑義照会")){const c=r("推定される要因:",n.estimatedText);c&&a.appendChild(c);const o=r("薬局での取り組み:",n.effortText);o&&a.appendChild(o)}else{const c=r("背景・要因:",n.factor);c&&a.appendChild(c);const o=r("発生要因:",n.factors);o&&a.appendChild(o);const s=r("発生要因(疑義照会):",n.factorDoubts);s&&a.appendChild(s);const i=r("改善策:",n.improvement);i&&a.appendChild(i)}e.resultsContainer.appendChild(a)})}function j(){if(p.length!==0){for(let t=p.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[p[t],p[n]]=[p[n],p[t]]}e.resultsContainer.innerHTML="",T=0,N()}}async function _(){const t=e.searchInput?.value?.trim()||"",n=e.filterInput?.value?.trim()||"",a=new URLSearchParams;t&&a.set("keyword",t),n&&a.set("filter",n);const l=`${window.location.origin+window.location.pathname}?${a.toString()}`;try{await navigator.clipboard.writeText(l),x("検索条件のURLをクリップボードにコピーしました","success")}catch(u){console.error("Failed to copy to clipboard:",u),x("URLのコピーに失敗しました","error")}}function Y(){$(),e.searchInput&&e.searchInput.addEventListener("keypress",r=>{r.key==="Enter"&&C()}),e.filterInput&&e.filterInput.addEventListener("keypress",r=>{r.key==="Enter"&&C()}),e.searchBtn&&e.searchBtn.addEventListener("click",()=>{console.log("[Hiyari Debug] Search button clicked"),C()}),e.randomBtn&&e.randomBtn.addEventListener("click",j),e.reloadButton&&e.reloadButton.addEventListener("click",()=>{e.searchInput&&(e.searchInput.value=""),e.filterInput&&(e.filterInput.value=""),e.resultsContainer&&(e.resultsContainer.innerHTML="");const r=document.getElementById("load-more-btn");r&&r.remove(),w(),document.body.classList.remove("search-mode"),e.usageGuide&&e.usageGuide.classList.remove("hidden");const l=new URL(window.location);l.search="",window.history.pushState({},"",l)}),e.shareBtn&&e.shareBtn.addEventListener("click",()=>_());const t=new URLSearchParams(window.location.search),n=t.get("drugName")||t.get("ingredientName")||t.get("keyword"),a=t.get("filter");n&&e.searchInput&&(e.searchInput.value=n),a&&e.filterInput&&(e.filterInput.value=a),(n||a)&&e.searchInput&&C()}document.addEventListener("DOMContentLoaded",Y);document.addEventListener("DOMContentLoaded",()=>{const t=[{element:document.getElementById("search-input"),text:"医薬品名または成分名を入力",speed:100},{element:document.getElementById("filter-input"),text:"事例内容、背景・要因で検索",speed:100}];F(t,300)});
