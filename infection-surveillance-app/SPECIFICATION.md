# 感染症動向可視化システム仕様書

## 1. 概要
国立感染症研究所が発表する感染症発生動向調査（IDWR）の速報データを自動的に集計・加工し、一般向けに分かりやすく可視化するWebアプリケーション。

## 2. システム構成
- **バックエンド**: Google Apps Script (GAS) Web App
  - データ取得・保存（IDWRからCSVをダウンロードしGoogleスプレッドシートに保存）
  - データ提供（スプレッドシートを中間DBとして利用し、`doGet`でCSV出力）
- **フロントエンド**: 静的HTML, CSS, JavaScript (GitHub Pages等でのホスティングを想定)
  - CSVデータの取得・パース
  - データの可視化（地図、グラフ、サマリー）

## 3. バックエンド仕様 (GAS Web App)

### 3.1. データ取得・更新ロジック
- **データソース**: 国立感染症研究所 IDWR速報データ (CSV)
  - 以下のデータを取得・保存する。
    1. **定点把握疾患（週報告）**: `...-teiten.csv` (Teitenシート)
    2. **ARI**: `...-ari.csv` (ARIシート)
    3. **定点把握疾患（当該週まで）**: `...-teiten-tougai.csv` (Tougaiシート)
- **実行トリガー**: 毎週木曜日 18:00 に定期実行。

### 3.2. データ加工・保存処理
- 取得したCSVデータをGoogleスプレッドシートの各シート（Teiten, ARI, Tougai）に書き込む。
- **履歴データの保存**: 最新の週報データ（`...-teiten-tougai.csv`）をGoogleドライブの「過去週報」フォルダに保存する。
  - 保存前に同名のファイルが存在するかチェックし、重複保存を防止する。
- スプレッドシートは「リンクを知っている全員が閲覧可」に設定。

### 3.3. データ出力・API提供
- GAS Web Appの `doGet` 関数は、リクエストパラメータ `type` に応じてスプレッドシートのデータをCSV形式（UTF-8）で返す。

## 4. フロントエンド仕様 (HTML/CSS/JS)

### 4.1. デザイン
- 2カラムレイアウト（左：地図/グラフ、右：ランキング/詳細）。
- **サマリーカード**: ホバーエフェクト付きのカードデザイン。選択中の疾患は色分け（インフルエンザ:赤、COVID-19:緑、ARI:橙）で強調表示。

### 4.2. 機能
- **CSV取得・パース**: `Teiten`, `ARI`, `Tougai` の各シートを取得。
- **サマリー表示**: 注目すべき感染症の状況をカード形式で表示。カードクリックで全ビュー（地図、ランキング、詳細パネル）が連動して切り替わる。
- **グラフ表示**: Chart.jsを利用。
  - **右パネル**: 疾患ごとの都道府県別報告数ランキング（Top10）。
  - **県別トレンドグラフ**: 地図上のエリアまたは詳細リストの県名をクリックすると、地図と入れ替わりで表示される。
    - 流行レベル（注意報・警報）に応じて線の色が変化（緑/黄/オレンジ/赤）。
    - **グラフ表示の維持**: グラフ表示中にサマリーカードで疾患を切り替えた場合、地図に戻らず、選択中の都道府県のグラフを維持して疾患のみを切り替える。同時に、その都道府県が属する地域の詳細パネルも更新して表示する。
    - **インタラクティブな凡例**: 凡例の年をクリックすると、その年のグラフを強調表示（太線・色付き）し、他の年をグレーアウトする。
    - **Y軸スケールの統一**: すべての都道府県で、その疾患の全国最大値（過去データ含む）に合わせてY軸の最大値を固定し、地域間の比較を容易にする。
    - **ポイントサイズ調整**: 今年のデータの視認性を高めるため、ポイントサイズを調整（今年: 2.5, 過去: 1）。
    - **ARIの例外処理**: 急性呼吸器感染症 (ARI) の場合はグラフを表示せず、「データはありません」等のメッセージを表示する。
  - **地域詳細パネル**:
    - 初期表示時および未選択時は「地図上のエリアをクリックすると詳細が表示されます。」というメッセージを表示する。
- **その他の感染症画面**:
  - 主要3疾患以外（流行性耳下腺炎などを含む）の週次推移を一覧表示。
  - 上部のサマリーカードやタイトルヘッダーは非表示にする。
  - 都道府県選択用のプルダウンを備え、選択した都道府県のグラフを表示する（メイン画面での選択を引き継ぐ）。
  - グラフクリックによる遷移は無効化。
- **ヒートマップ表示**: 日本地図SVG。
  - COVID-19: 注意報レベル（10.0）未満は緑。
  - ARI: 80以上で注意（黄）、120以上で流行（赤）。
- **アコーディオンメニュー**: 「地図の使い方・色の基準」
  - 閉じた状態ではタイトルと簡単な説明を1行で表示。
  - 開いた状態で詳細な説明を全文表示。

### 4.3. 基準値（閾値）

各疾患について、以下の基準値（定点当たり報告数）に基づき、グラフや地図の色分けを行う。

| 疾病 | 警報レベル (開始) | 警報レベル (終息) | 注意報レベル | 流行期入り (目安) |
| :--- | :--- | :--- | :--- | :--- |
| **インフルエンザ** | 30.0 | 10.0 | 10.0 | 1.00 |
| **COVID-19** | 15.0 | - | 10.0 | - |
| **急性呼吸器感染症 (ARI)** | 120.0 | - | 80.0 | - |
| **咽頭結膜熱** | 3.0 | 1.0 | - | - |
| **A群溶血性レンサ球菌咽頭炎** | 8.0 | 4.0 | - | - |
| **感染性胃腸炎** | 20.0 | 12.0 | - | - |
| **水痘** | 2.0 | 1.0 | 1.0 | - |
| **手足口病** | 5.0 | 2.0 | - | - |
| **伝染性紅斑** | 2.0 | 1.0 | - | - |
| **ヘルパンギーナ** | 6.0 | 2.0 | - | - |
| **流行性耳下腺炎** | 6.0 | 2.0 | 3.0 | - |
| **急性出血性結膜炎** | 1.0 | 0.1 | - | - |
| **流行性角結膜炎** | 8.0 | 4.0 | - | - |

※ グラフ等の色分けロジックでは、主に「警報レベル(開始)」「注意報レベル」「流行期入り」の値を閾値として使用する。