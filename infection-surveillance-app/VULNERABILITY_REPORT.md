# 脆弱性診断レポート: Infection Surveillance App

## 概要
本レポートは、`infection-surveillance-app` のセキュリティ分析結果をまとめたものです。本アプリケーションは Google Apps Script (GAS) バックエンドと静的 HTML/JS フロントエンドで構成されています。

**実施日:** 2025年12月13日
**対象:** `search-for-medicine-test03/infection-surveillance-app`

## 診断結果

### 1. バックエンド (Code.gs)

*   **公開ファイル共有設定 (中リスク):**
    *   関数 `getOrCreateSpreadsheet_` において、作成されるスプレッドシートの共有設定が `DriveApp.Access.ANYONE_WITH_LINK`（リンクを知っている全員が閲覧可能）および `DriveApp.Permission.VIEW` に設定されています。
    *   **影響:** スプレッドシートIDを推測または入手した第三者が、生データを閲覧できる状態です。これがオープンデータプロジェクトとしての意図的な仕様であれば問題ありませんが、未公開データや内部メモが含まれる場合はリスクとなります。
    *   **推奨事項:** データが完全に公開用であればそのままで問題ありません。そうでない場合は、特定のユーザーまたはドメイン内 (`DriveApp.Access.DOMAIN`) にアクセスを制限することを推奨します。

*   **設定値のハードコーディング (低リスク):**
    *   `PARENT_FOLDER_ID` がコード内に直接記述されています。フォルダID自体は機密情報ではありませんが、ドライブ構成が露呈します。
    *   **推奨事項:** 変更の柔軟性とコードのクリーンさを保つため、Google Apps Script の `PropertiesService`（スクリプトプロパティ）を使用して設定値を管理することを推奨します。

*   **エラーハンドリング:**
    *   `doGet` 関数はエラー発生時にテキスト形式 (`ContentService.MimeType.TEXT`) でエラーメッセージを返しますが、フロントエンドは常にCSVを期待しています。エラー発生時、フロントエンドがエラーメッセージをCSVとしてパースしようとし、予期せぬ表示になる可能性があります。

### 2. フロントエンド (index.html, main.js, map.js)

*   **Content Security Policy (CSP) (対応済み):**
    *   **[修正済]** `style-src` ディレクティブから `'unsafe-inline'` が削除されました。
    *   **分析:** 以前は動的なスタイル適用のために `'unsafe-inline'` が許可されていましたが、これによりスタイルインジェクション攻撃のリスクが存在しました。今回の修正で、JavaScriptによるインラインスタイルの適用をすべて排除し、CSSクラスの付け外しで動的なスタイル変更を実現するようコードをリファクタリングしました。
    *   **結果:** これにより、より厳格なCSPを適用することが可能になり、クロスサイトスクリプティング（XSS）の一種であるスタイルインジェクション攻撃に対する耐性が大幅に向上しました。

*   **DOM操作 / XSSリスク (低リスク):**
    *   `main.js` の数箇所（`renderSummary`, `renderOtherDiseasesList` など）で `innerHTML` が使用されています。
    *   **分析:** 現在 `innerHTML` に挿入されている内容は、ハードコードされた定数、数値データ、生成されたアラート文言であり、外部からの悪意ある入力が直接混入する経路は見当たりません。
    *   **結論:** データソース（GASバックエンドおよび感染研CSV）が信頼できる限り、リスクは低いと判断されます。
    *   **推奨事項:** HTMLタグを含まないテキスト情報の更新には、将来的なXSSリスクを排除するため `textContent` を使用することを推奨します。

*   **フロントエンドのエラー表示:**
    *   `main.js` (1066行目): `summaryCards.innerHTML = ... ${error.message}`
    *   バックエンドからの応答や通信エラーの内容を表示していますが、万が一バックエンドが侵害され悪意あるスクリプトを含むメッセージを返した場合、XSSにつながる可能性があります。

### 3. データの整合性

*   **CSVパース処理:**
    *   バックエンド・フロントエンド共に簡易的な独自のCSVパース処理を行っています。データのフォーマット（改行や引用符の扱いなど）が変更された場合、正しく読み込めなくなる可能性があります。

## まとめと推奨アクション

本アプリケーションは公開ダッシュボードとしての用途においては比較的安全ですが、より堅牢にするための「多層防御」として以下を推奨します。

1.  **データ公開範囲の再確認:** 生成されるスプレッドシートが「リンクを知る全員に公開」の設定で問題ないか、改めて確認してください。
2.  **DOM更新処理の改善:** HTMLタグが不要な箇所については、`innerHTML` から `textContent` への書き換えを推奨します。
3.  **プロパティサービスの活用:** フォルダIDなどの設定値をコードから分離し、スクリプトプロパティで管理してください。