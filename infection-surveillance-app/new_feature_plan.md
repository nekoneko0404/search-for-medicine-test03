# 感染症サーベイランス機能追加 計画書 (完了)

**ステータス: 実装完了 (2025/12)**

## 1. 目的

本計画書は、「感染症サーベイランス」アプリケーションに以下の機能を追加するための実装計画を定義する。

-   **機能1: その他の5類感染症の表示**
    -   既存のインフルエンザ、COVID-19、ARIに加え、他の主要な5類感染症の発生動向データを表示する。
    -   「その他の感染症」として新しいビュー（一覧画面）を用意し、各感染症の全国トレンドグラフを並べて表示する。
    -   一覧から特定の感染症を選択すると、既存の地図ビューと同様にエリア→都道府県へと詳細を確認できる。
-   **機能2: 過去データの比較表示**
    -   すべてのグラフ（既存・新規含む）において、当年のデータに加え、過去の年のデータを重ねて表示する。
    -   **配色ルール:**
        -   当年 (2025年): 現在の疾患別カラー（または赤/警告色）
        -   昨年 (2024年): 水色 (`#87CEEB`等)
        -   それ以前 (2023年以前): 薄いグレー (`#E0E0E0`等)

## 2. 前提と確認事項

### データソース
-   **当年のデータ:** 
    -   `Code.gs`が国立感染症研究所のサイトから最新週のCSVを取得し、スプレッドシートに保存する既存の仕組みを利用。
    -   ただし、対象疾患が増えるため、スプレッドシートの読み込みロジックが全列に対応する必要がある。
-   **過去のデータ:** 
    -   指定されたGoogle Driveフォルダ内のCSVファイルを利用する。
    -   **ファイル命名規則:** `YYYY-WW-teiten-tougai.csv` (例: `2024-52-teiten-tougai.csv`)
    -   各ファイルは、その年の第1週から当該週（通常は最終週）までの累積データを含む。
-   **対象疾患リスト:**
    -   インフルエンザ、COVID-19、ARI（既存）
        -   **注記:** COVID-19については、現在週ごとの詳細な過去データ（定点把握）が公表されていないか、フォーマットが異なるため、過去比較グラフの表示対象外とします。
    -   ＲＳウイルス感染症、咽頭結膜熱、Ａ群溶血性レンサ球菌咽頭炎、感染性胃腸炎、水痘、手足口病、伝染性紅斑、突発性発しん、ヘルパンギーナ、流行性耳下腺炎、急性出血性結膜炎、流行性角結膜炎、細菌性髄膜炎、無菌性髄膜炎、マイコプラズマ肺炎、クラミジア肺炎、感染性胃腸炎（ロタウイルス）

### UI/UX設計
-   **画面遷移:**
    -   **トップ画面（既存）:** 主要3疾患（インフルエンザ、COVID-19、ARI）のサマリーカードと地図。
    -   **「その他の感染症」ボタン:** ヘッダーまたはサマリーエリアに追加。
    -   **一覧画面（新規）:** 
        -   上記リストにある全感染症の「全国」週次推移グラフをタイル状（グリッド）に表示。
        -   各タイルには「当年」「昨年」「過去平均(?)または各年」のグラフが描画される。
    -   **詳細遷移:** 
        -   一覧画面のグラフをクリック -> その感染症を選択状態にしてトップ画面（地図ビュー）へ遷移。
        -   ユーザーは地図をクリックして都道府県を選択 -> 右パネルにその県の過去比較グラフが表示される。

## 3. 実装方針

### 3.1. バックエンド (`Code.gs`) の改修

1.  **過去データ取得API (`getHistoryData`):**
    -   指定Driveフォルダからファイル名パターン `^\d{4}-\d{2}-teiten-tougai\.csv$` に一致するファイルを検索。
    -   ファイル名から「年」を特定。
    -   各ファイルのCSVデータを読み込み、連結または構造化データとしてクライアントに返す。
    -   `doGet` パラメータ `type=history` で呼び出し可能にする。
    -   **最適化:** データ量が多いため、初回ロード時に一度だけ取得するか、必要なデータのみ抽出して軽量化することを検討（今回は全量取得しクライアントキャッシュを想定）。

2.  **データパース処理:**
    -   CSV内の「疾患名」ヘッダーを動的に探索し、列インデックスを特定するロジックを強化（固定列ではなく、名前マッチング）。

### 3.2. フロントエンド (`main.js`, `style.css`) の改修

1.  **データ管理 (`cachedData`の拡張):**
    -   現在の `{ data, history, summary }` 構造に加え、`historicalArchives` (過去数年分の全データ) を保持する。
    -   データ構造イメージ:
        ```javascript
        {
          current: { ... }, // 2025年データ
          archives: [
            { year: 2024, data: [...] },
            { year: 2023, data: [...] }
          ]
        }
        ```

2.  **データ処理ロジック (`processData`の改修):**
    -   `parseTougaiRows` を汎用化し、任意の疾患名リストに基づいてデータを抽出できるようにする。
    -   過去データCSVに対しても同じパーサーを適用できるようにする。

3.  **UIコンポーネント:**
    -   **「その他の感染症」一覧ビュー:**
        -   DOM要素生成: 疾患リストをループし、Canvas要素を含むカードを作成。
        -   グラフ描画: 各Canvasに `Chart.js` で全国データの比較グラフを描画。
    -   **グラフ描画関数 (`renderComparisonChart`):**
        -   引数: 疾患名、対象地域（デフォルト全国）、データセット配列。
        -   データセット構成:
            -   2025年: 線（太め）、色（疾患固有 or 赤）
            -   2024年: 線（普通）、色（水色）
            -   2023年以前: 線（細め）、色（グレー）

4.  **インタラクション:**
    -   「その他の感染症」一覧でクリック -> `switchDisease(clickedDisease)` を呼び出し、ビューを地図モードに戻す（これで自動的にその病気の地図になる）。

## 4. 実装タスクリスト（ToDo）

### フェーズ1: データ取得・整備
1.  **[Code.gs] 過去データ取得機能の実装**
    -   DriveAppでファイル検索
    -   CSV読み込みとレスポンス生成
2.  **[Code.gs] doGetの改修**
    -   `type=history` 対応
3.  **[Front] データフェッチ処理の実装**
    -   `init` 関数で `fetchCSV('history')` (仮) を呼び出し。
    -   取得した複数年CSVデータのパース処理実装。

### フェーズ2: ロジック改修
4.  **[Front] パーサーの汎用化**
    -   `parseTeitenRows`, `parseTougaiRows` を特定疾患ハードコードから、リストベースの動的抽出へ変更。
    -   対象全疾患のリスト定義作成。

### フェーズ3: UI実装（グラフ・一覧）
5.  **[Front] 比較グラフコンポーネントの実装**
    -   `Chart.js` の設定を作成（当年・昨年・過去の色分け）。
    -   既存の `showPrefectureChart` をこの新コンポーネントを利用するように更新。
6.  **[Front] 「その他の感染症」一覧ビューの作成**
    -   HTML: コンテナ追加。
    -   CSS: グリッドレイアウト定義。
    -   JS: 疾患リストループでグラフカード生成処理。
7.  **[Front] ナビゲーション実装**
    -   「その他の感染症」ボタン配置。
    -   ビュー切り替えロジック（地図 ⇔ 一覧）。
    -   一覧からのドリルダウン遷移実装。

### フェーズ4: 調整・テスト
8.  **UI調整**
    -   レスポンシブ対応確認。
    -   色味の調整。
9.  **動作テスト**
    -   データの不整合がないか（週ズレなど）確認。
