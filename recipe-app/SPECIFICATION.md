# 健康レシピ提案アプリ (Recipe App) 仕様書

## 1. 概要
ユーザーの体調（症状）、手持ちの食材、希望する料理ジャンル、調理時間の制約に基づいて、AI (OpenAIまたはGemini) を用いて最適なレシピを提案するWebアプリケーション。

## 2. システム構成
- **フロントエンド**: HTML5, Tailwind CSS, Vanilla JavaScript
- **バックエンド**: Cloudflare Workers (`recipe-worker`)
- **AIモデル**: 
  - OpenAI GPT-4o-mini
  - Google Gemini 3 Flash Preview (選択可能)

## 3. 機能要件

### 3.1 ユーザー入力
ユーザーは以下の情報を入力できる。
1.  **体調・気になること**:
    - プリセット（血圧、血糖値など）の複数選択。
    - **その他（自由記述）**：個別の症状や気分を入力可能。
2.  **使いたい食材**:
    - フリーテキスト入力（最大3つ）。
3.  **料理ジャンル**:
    - 和食、洋食、中華、イタリアン、韓国料理、エスニック。
4.  **調理時間**:
    - 10分以内（時短）、30分以内（普通）、こだわらない（じっくり）。
5.  **詳細設定**:
    - **AIモデルとキー設定**:
        1.  **おまかせ (無料)**: システム共有のGemini APIキーを使用（Gemini 3.0 Flash, 1日の回数制限あり）。
        2.  **OpenAI (自分のキーを使用)**: ユーザー自身のOpenAI APIキーを使用。
        3.  **Google Gemini (自分のキーを使用)**: ユーザー自身のGemini APIキーを使用。
    - **APIキー入力**: 
        - 上記2, 3を選択した場合のみ入力欄を表示。
        - セキュリティリスクについての警告を表示。

### 3.2 制限管理
- **システムモデル制限**:
    - Gemini APIの無料枠制限（Rate Limit）に準拠。
    - 制限超過時（429エラー）は「本日の利用上限に達しました」というメッセージを表示し、自身のキー利用を促すUIを表示する。
- **制約**:
    - 治療・治癒などの医学的表現は不可。免責事項を表示。
    - 具体的なレシピ（材料、手順）を提示。
    - 明るいトーンで励ます。
- **出力形式**: JSON（メッセージ + レシピリスト）。

### 3.3 表示機能
- AIからのメッセージ（アドバイス）。
- レシピカード（3つ提案）:
    - 料理名
    - 調理時間、カロリー（概算）
    - インジケーター（健康ポイント、材料リスト、手順）

## 4. セキュリティ設計
- **APIキー保護**:
    - システムAPIキー (`OPENAI_API_KEY`, `GEMINI_API_KEY`) はCloudflare Worker環境変数に保存。
    - クライアントサイドには一切露出させない。
- **リスク管理**:
    - ユーザー自身のAPIキーを利用する場合のリスク（盗聴、流出）について、入力欄付近に明示的な警告を表示。

## 5. ディレクトリ構成
- `recipe-app/`: フロントエンド資材
    - `index.html`: UIメイン
    - `css/style.css`: スタイル定義
    - `js/script.js`: アプリケーションロジック
- `recipe-worker/`: バックエンド資材
    - `src/index.js`: Workerロジック (OpenAI/Geminiアダプター含む)
    - `wrangler.toml`: Worker設定

## 6. セキュリティ対策
- **XSS対策**: AI生成コンテンツ（レシピ名、手順など）の表示時に、HTML特殊文字をエスケープ処理し、スクリプト実行を防止。
- **入力検証 (Backend)**: リクエスト全体のサイズを制限し、巨大な入力によるトークン浪費やDoS攻撃を緩和。
- **CORS**: 基本的に全許可（`*`）とするが、Backend側で適切なメソッド制限とエラーハンドリングを行う。
- **エラーハンドリング**: 429 Too Many Requests を明示的に処理し、システム保護とユーザビリティを両立。
