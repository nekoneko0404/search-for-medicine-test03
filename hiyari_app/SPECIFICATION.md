# 薬局ヒヤリ・ハット事例ビューア - 仕様書

## 1. アプリケーション名
【Kusuri Compass】薬局ヒヤリ・ハット事例ビューア

## 2. 概要
本Webアプリケーションは、日本医療機能評価機構が提供する「薬局ヒヤリ・ハット事例収集等事業」の公開APIを利用し、薬局におけるヒヤリ・ハット事例を検索・閲覧するためのシングルページアプリケーションです。医薬品名や事例内容のキーワードで事例を検索し、結果を閲覧できます。

## 3. 機能一覧

### 3.1. 事例表示
*   **初期表示:** デフォルトでは、APIから最新のヒヤリ・ハット事例が最大100件取得され、最初の30件が表示されます。
*   **検索結果表示:** 検索キーワードに合致した事例が表示されます。
*   **ページネーション:** 「さらに表示」ボタンをクリックすることで、次の30件が画面に追加表示されます。全件表示されるとボタンは非表示になります。
*   **カード表示:** 各事例はカード形式で表示され、以下の情報が含まれます。
    *   事例の概要 (例: 調剤に関するヒヤリ・ハット事例)
    *   発生年月
    *   事例の詳細
    *   背景・要因
    *   発生要因
    *   改善策
*   **ローディング表示:** APIからデータを取得中は、スピナーアニメーションが表示されます。
*   **結果なし/エラー表示:** 検索結果が存在しない場合や、API通信でエラーが発生した場合は、その旨を伝えるメッセージが画面に表示されます。

### 3.2. 検索・操作機能
*   **医薬品名検索:**
    *   「医薬品名」入力フィールドに医薬品名や成分名を入力し、「検索」ボタンまたはEnterキーで検索を実行します。
    *   URLパラメータ `ingredientName` または `drugName` が存在する場合、ページ読み込み時に自動で検索が実行されます。
*   **絞り込み検索:**
    *   「絞り込み」入力フィールドにキーワード（事例内容、背景・要因など）を入力し、「絞り込み」ボタンまたはEnterキーで検索を実行します。
    *   URLパラメータ `word` が存在する場合、ページ読み込み時に自動で絞り込み検索が実行されます。
*   **組み合わせ検索:**
    *   「医薬品名」と「絞り込み」の両方にキーワードが入力された場合、両方の条件を満たす（AND検索）事例を検索します。
*   **ランダム表示:**
    *   「ランダム」ボタンをクリックすると、現在読み込まれている事例の表示順をシャッフルします。
*   **クリア:**
    *   「クリア」ボタンをクリックすると、全ての入力フィールドと検索結果がリセットされます。

## 4. データ処理 (XMLパース)
*   APIから取得したXML形式のデータを`DOMParser`を用いてパースします。
*   XML内の各コード値（例: `DATSUMMARY` の `01`）を、`script.js`内で定義されたマッピングオブジェクトを用いて、利用者が理解しやすい日本語のテキスト（例: `調剤に関するヒヤリ・ハット事例`）に変換して表示します。
*   主に以下のコードがマッピング対象です。
    *   `DATSUMMARY`: 事例の概要区分
    *   `DATMONTH`: 発生月
    *   `DATCONTENTTEXT`: 事例内容
    *   `DATFACTORTEXT`: 背景・要因
    *   `DATFACTOR`: 発生要因
    *   `DATFACTORDOUBT`: 発生要因（疑義照会）

## 5. セキュリティ
*   **入力値のサニタイズ:** ユーザーが入力したキーワードは、検索実行前に不要な文字を削除するサニタイズ処理が行われます。
*   **コンテンツセキュリティポリシー (CSP):** `index.html`の`<meta>`タグでCSPが設定されており、許可されたドメイン以外からのスクリプト実行やリソース読み込みをブロックします。

## 6. 技術スタック
*   **フロントエンド:** HTML, JavaScript, Tailwind CSS
*   **API連携:** `fetch` API, `DOMParser`

## 7. API連携仕様
*   **APIエンドポイント:** `https://hiyari-proxy-708146219355.asia-east1.run.app/proxy` (Cloud Run上にデプロイされたプロキシ経由)
*   **参照API仕様書:** [薬局ヒヤリ・ハット事例収集・分析事業 テキストデータ提供 API仕様書 Ver.2](https://www.yakkyoku-hiyari.jcqhc.or.jp/pdf/text_api_specification_v2.pdf)
*   **リクエストパラメータ詳細:**
    *   `count=100`: 取得件数を100件に固定。
    *   `order=2`: 発生年月が新しい順でソート。
    *   **医薬品名のみ入力時:**
        *   `item=DATMEDNAME`
        *   `word=[医薬品名]`
        *   `condition=any` (部分一致)
    *   **絞り込みキーワードのみ入力時:**
        *   `word=[絞り込みキーワード]`
    *   **医薬品名と絞り込みキーワードを両方入力時:**
        *   `word=[医薬品名] [絞り込みキーワード]` (スペース区切りで結合)
        *   `condition=all` (AND検索)

## 8. UI/UX
*   **レイアウト:** Tailwind CSSを使用したレスポンシブデザイン。医薬品名検索と絞り込み検索のエリアが横並びに配置されています。
*   **動的タイトル:** 検索キーワードに応じて、ページ上部のタイトル (`<h2 id="search-title">`) が動的に「『〇〇』に関するヒヤリ・ハット事例」のように変化します。
*   **スタイリング:** `unify.css`で共通スタイルを定義しつつ、Tailwind CSSのユーティリティクラスで各要素のスタイルが設定されています。基調色はグレーとインディゴが使用されています。

## 9. 今後の課題
*   APIが `word` パラメータのみで複数の `item` を暗黙的に検索しない場合、クライアント側でのフィルタリングが必須となります。大量のデータを取得してクライアント側でフィルタリングする場合、パフォーマンスの最適化が必要になる可能性があります。
*   検索キーワードと絞り込みキーワードの組み合わせ検索において、API側でより柔軟な検索オプションが提供されれば、クライアント側のロジックを簡素化できます。
