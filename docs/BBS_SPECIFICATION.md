# 匿名掲示板 (anonymous-bbs) 仕様書

## 1. 概要
「Kusuri Compass」のユーザーコミュニティとして、匿名で質問・相談ができる掲示板システム。

## 2. 機能仕様
### 2.1 投稿機能
- **文字数制限**: 最大400文字。
- **連投制限**: 一般ユーザーは同一IPから3時間は再投稿不可。
- **削除機能**: 投稿時に発行されるローカルの削除キー、または管理者キーにより可能。

### 2.2 管理者機能
- **管理者判定**: URLパラメータ `?key=[ADMIN_KEY]` を保持している場合に有効。
- **管理者モードの視覚的強調**: 
    - 画面上部（投稿フォーム内）に「管理者モード」を示すバナーを表示。
    - 投稿フォーム全体の枠線を強調色に変更。
    - 送信ボタンを強調色（オレンジ）に変更し、テキストを「管理者として送信する」に変更。
- **特権**:
    - 3時間の連投制限の除外。
    - すべての投稿の削除権限。
    - 管理者専用バッジ（控えめなグレー）の表示。
    - 画面上の連投制限警告の非表示化。

### 2.3 ユーザービリティ機能
- **投稿番号**: すべての投稿に連番が割り振られる。
- **アンカー (返信)**:
    - 形式: `>>[番号]`
    - ジャンプ: クリックで対象投稿へスクロールし、ハイライト表示。
    - プレビュー: ホバー時にポップアップで内容を表示。

## 3. システム構成
### 3.1 バックエンド
- **プラットフォーム**: Cloudflare Workers
- **データベース**: Cloudflare D1 (SQLiteベース)
- **キャッシュポリシー**: リアルタイム反映を優先するため `no-store` を採用。

### 3.2 フロントエンド
- **構成**: Vanilla HTML / CSS / JavaScript
- **セキュリティ (CSP)**: 
    - Google Analytics (`googletagmanager.com`) を許可。
    - ローカル開発用の Websocket 通信を許可。

## 4. データベース定義
```sql
CREATE TABLE posts (
  id TEXT PRIMARY KEY,
  post_number INTEGER, -- 追加
  content TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  deleted_at INTEGER,
  delete_key TEXT NOT NULL,
  ip_address TEXT,
  is_admin BOOLEAN DEFAULT 0 -- 追加
);
```

## 5. 採用理由と代替案の比較
- **キャッシュ無効化の採用**: 当初 Cache API による高速化を検討したが、管理者による投稿や削除の即時反映というユーザー体験を優先し、DBへの直接参照（`no-store`）を選択した。D1 の読み取り速度により、100件程度のデータ取得では実用上の問題はないと判断。
- **CSPの調整**: セキュリティを維持しつつ、Google Analytics やローカルの Live Preview 機能を共存させるため、必要最小限の例外設定（`unsafe-inline`, `ws:`）を適用した。
