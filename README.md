# Kusuri Compass - 医薬品情報検索アプリケーション

Kusuri Compassは、医薬品の出荷状況や関連情報を多角的に検索・分析するためのWebアプリケーション群です。4つの主要な機能（出荷状況検索、情報更新日検索、YJコード検索、ヒヤリハット事例ビューア）で構成されています。

## 1. アプリケーションのコンセプト

本アプリケーションは、単一のGoogleスプレッドシートをマスターデータとして利用し、クライアントサイドでデータを処理・表示するアーキテクチャを採用しています。

*   **データソース:** GoogleスプレッドシートからCSV形式でデータを取得します。
*   **クライアントサイドキャッシュ:** `localforage`を利用し、取得したデータをユーザーのブラウザに1時間キャッシュします。これにより、2回目以降のアクセス時に高速なデータ表示を実現し、APIへのリクエストを最小限に抑えます。
*   **データ更新:** 各ページにある更新ボタン（🔄）を押すことで、キャッシュを強制的にクリアし、最新のデータを再取得できます。

## 2. 機能モジュール詳細

### 2.1. 出荷状況検索 (メイン)
医薬品の品名や成分名から、現在の出荷状況を検索するメイン機能です。

*   **ファイル:** `index.html`, `js/main.js`
*   **機能:**
    *   医薬品名、成分名、規格/剤形/メーカー名の各項目でAND検索が可能です。
    *   「規格/剤形/メーカー名」の欄では、入力されたキーワードが品名、成分名、規格、メーカー名のいずれかに合致するものを検索します。
    *   また、キーワードの先頭に「-」（ハイフン）または「ー」（長音符）を付けることで、そのキーワードを含む結果を除外できます。（例: `錠 -あすか`）
    *   「通常出荷」「限定出荷」「供給停止」のステータスで結果をフィルタリング。
    *   検索結果はテーブル形式で表示され、品名、成分名、出荷状況でのソートが可能。
    *   品名をクリックすると、以下の関連情報へドリルダウンできます。
        *   **医薬品情報:** PMDAの添付文書ページへリンク。
        *   **代替薬検索:** `YJコード検索`ページへ遷移し、代替候補薬を検索。
        *   **情報更新日:** `情報更新日検索`ページへ遷移し、その薬剤の更新履歴を表示。
        *   **ヒヤリハット検索:** `ヒヤリ・ハット事例ビューア`へ遷移し、関連するインシデントを検索。

### 2.2. 情報更新日検索
データの更新履歴に特化した検索機能です。いつ、どの医薬品情報が更新されたかを追跡できます。

*   **ファイル:** `update/index.html`, `update/js/main.js`
*   **機能:**
    *   品名、成分名、規格、メーカー名でのキーワード検索が可能です。
    *   大文字・小文字、全角・半角、ひらがな・カタカナを区別せずに検索できます。
    *   キーワードの先頭に「-」（ハイフン）または「ー」（長音符）を付けることで、除外検索が可能です。
    *   入力後、0.3秒待って自動的に検索が実行されます（日本語変換中は検索されません）。
    *   「3日以内」「7日以内」といった期間を指定して、情報が更新された薬剤をフィルタリング。
    *   出荷状況や供給状況の変動（⤴️ ⤵️）でも絞り込みが可能。
    *   最近供給が再開された、あるいは停止した医薬品を素早く見つけるのに役立ちます。

### 2.3. YJコード検索
YJコードを基に、薬効や剤形が類似する代替薬を検索する機能です。

*   **ファイル:** `yjcode/index.html`, `yjcode/js/main.js`
*   **機能:**
    *   12桁のYJコードを入力して検索。
    *   薬効分類、成分、剤形など、YJコードの特定の部分（桁）が一致する薬剤を検索条件として指定可能。
    *   これにより、同一薬効群や同一成分の代替薬候補を一覧表示できます。
    *   メーカー名をクリックすると、各社のWebサイト（情報提供ページなど）へ直接アクセスできます。（※別途管理されているGoogleスプレッドシートのURLリストを参照）

### 2.4. 薬局ヒヤリ・ハット事例ビューア
医薬品に関連するヒヤリ・ハット事例（インシデントレポート）を検索・閲覧する機能です。

*   **ファイル:** `hiyari_app/index.html`, `hiyari_app/js/main.js`
*   **機能:**
    *   日本医療機能評価機構が提供する「薬局ヒヤリ・ハット事例収集等事業」の公開APIを利用。
    *   医薬品名や事例内容のキーワードでインシデントを検索。
    *   APIへのリクエストは、CORSポリシーを回避するためにCloud Run上のプロキシを経由して行われます。
    *   詳細な仕様は `hiyari_app/SPECIFICATION.md` を参照してください。

## 3. 技術仕様

*   **フロントエンド:** HTML, JavaScript, Tailwind CSS
*   **データストレージ:** LocalForage (IndexedDB/WebSQL/LocalStorageのラッパー)
*   **データソース:**
    *   **医薬品情報:** Google Sheets (File ID: `1ZyjtfiRjGoV9xHSA5Go4rJZr281gqfMFW883Y7s9mQU`)
    *   **メーカーURL:** Google Sheets (File ID: `1lTHHbUj6ySAgtum8zJrHjWAxYnbOO9r8H8Cnu-Y0TnA`)
*   **利用API:**
    *   Google Sheets API (gviz/tq CSVエクスポート) 
    *   薬局ヒヤリ・ハット事例提供API (プロキシ経由)
*   **その他:**
    *   **分析:** Google Analytics (gtag.js)
    *   **セキュリティ:** Content Security Policy (CSP) を導入し、許可されたドメインからのリソース読み込みのみを許可。

## 4. 使い方・セットアップ

1.  リポジトリをクローンまたはダウンロードします。
2.  Webサーバーのルートにファイルを配置するか、ローカルで `index.html` を直接ブラウザで開きます。
3.  初回アクセス時、Googleスプレッドシートからデータが読み込まれます。読み込みが完了すると、検索が可能になります。
4.  データが古い場合は、画面右下の `🔄` ボタンをクリックしてキャッシュをクリアし、最新のデータを取得してください。
5.  各機能の詳しい使い方は `help/index.html` を参照してください。

## 5. ファイル構成

- `index.html`: 出荷状況検索 (メインページ)
- `js/`: メインページおよび共通のスクリプト (`main.js`, `data.js`, `ui.js`, `utils.js` など)
- `unify.css`: 全ページ共通のスタイルシート
- `update/`: 情報更新日検索機能
- `yjcode/`: YJコード検索機能
- `hiyari_app/`: ヒヤリ・ハット事例ビューア
- `images/`: アイコンやスクリーンショット
- `help/`: 使い方ガイドページ
- `gtag.js`: Google Analytics設定

## 6. 免責事項

*   本ツールは、公的機関が公開しているデータに基づいて情報を表示しますが、その正確性、完全性、最新性を保証するものではありません。最終的な判断は、必ず公式サイトや添付文書をご確認ください。
*   本ツールの利用は、利用者自身の責任において行うものとします。開発者は、本ツールの利用によって生じたいかなる損害についても、一切の責任を負いません。
