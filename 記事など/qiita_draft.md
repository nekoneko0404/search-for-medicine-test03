# 【個人開発】薬剤師が感染症動向を可視化するWebアプリを作った話 (GAS + Chart.js)

国立感染症研究所が発表している「感染症発生動向調査（IDWR）」の速報データを、直感的に分かりやすく可視化するWebアプリ「Infection Surveillance App」を開発しました。
このアプリは、薬剤師業務支援Webアプリ **「Kusuri Compass」** の1機能として組み込まれています。

バックエンドに **Google Apps Script (GAS)**、フロントエンドに **Chart.js** を採用し、**完全無料・サーバーレス** で運用できる構成にしています。

この記事では、薬剤師としての開発の動機、システム構成、技術的なポイントについて紹介します。

## 開発の動機

私は普段、薬剤師として働いています。
実は、**4か月前まではコードを目にする機会もない、アプリ開発とは無縁の生活を送っていた薬剤師でした。**

そんな私が開発に取り組んだ理由は、現場で日々感じている「**感染症の流行状況によって、医薬品の需要が大きく変わる**」という課題を解決したかったからです。

ある感染症が流行すれば、関連する医薬品の需要が急増します。このとき準備が遅れれば「欠品」を招き、最悪の場合、患者さんの治療に影響が出てしまいます。
特に昨今は医薬品の供給不安が続いており、「**必要な医薬品を、必要な量だけ事前に確保すること**」は、私たち薬剤師にとって非常に重要なミッションとなっています。

国立感染症研究所が発表するIDWR（感染症発生動向調査）は、こうした需要予測のための重要な情報源です。しかし、元データはPDFやCSV形式で提供されており、忙しい業務の合間に「今、どの地域で何が流行り始めているのか？」「先週と比べてどう変化したのか？」を瞬時に把握するのは困難でした。

そこで、「**地図で流行状況をパッと一覧でき、クリック一つで詳細なトレンドが見られるツール**」があれば、医薬品の適正な在庫管理（需要予測）に役立つのではないかと考え、このアプリを開発しました。

https://x.com/oshigoto_twitte/status/1997577114028327234?s=20

## 作ったもの

**感染症動向可視化システム (Infection Surveillance App)**

主な機能は以下の通りです。

1.  **全国感染症動向の可視化**: インフルエンザ、COVID-19、急性呼吸器感染症 (ARI) に加え、**手足口病やRSウイルス感染症など、その他の主要な5類感染症**の状況も確認可能にしました。
2.  **都道府県別ヒートマップ**: 日本地図上で流行レベル（注意報・警報など）を色分け表示。
3.  **過去データ比較機能**: グラフ上で「今年」と「過去の年」のデータを重ねて表示し、例年と比較して流行が早いか遅いかを一目で判断できるようにしました。
4.  **県別トレンドグラフ**: 地図上のエリアや県名をクリックすると、その県の週次推移を表示。
5.  **自動更新**: 毎週発表されるデータを自動で取得・反映。

## システム構成

個人開発として運用コストをかけないため、以下の構成を採用しました。

*   **Frontend**: HTML5, CSS3, JavaScript (Vanilla JS), Chart.js
*   **Backend**: Google Apps Script (GAS), Google Sheets
*   **Infrastructure**: GitHub Pages (フロントエンド), Google Drive (データ保存)

### 処理の流れ

1.  **データ収集 (GAS)**:
    *   毎週木曜日にトリガー実行。
    *   国立感染症研究所のWebサイトから最新のCSVデータ（速報）をダウンロード。
2.  **データ保存 (GAS & Sheets)**:
    *   取得したCSVデータをGoogleスプレッドシートに書き込み（中間DBとして利用）。
    *   同時に、最新データを「過去週報」としてGoogleドライブに自動アーカイブ。
3.  **API提供 (GAS)**:
    *   GASの `doGet` 関数を利用して、Webアプリとして公開。
    *   フロントエンドからのリクエストに対し、スプレッドシートのデータをCSV形式で返却。
4.  **可視化 (Frontend)**:
    *   GASのWebアプリURLからデータを非同期取得。
    *   Chart.jsを用いてグラフや地図を描画。

## 技術的なポイント

### 1. GASを簡易バックエンドAPIとして利用する

GASの `Web Apps` 機能を使うと、簡単にAPIを作成できます。今回は `doGet` 関数でスプレッドシートの内容をCSVとして出力するだけのシンプルなAPIを構築しました。

```javascript:Code.gs
function doGet(e) {
  // パラメータに応じてシートを切り替え
  const sheetNameInput = e.parameter.type || 'Teiten';
  
  // ... (バリデーション処理など) ...

  const targetSheet = ss.getSheetByName(targetSheetName);
  const csvString = convertToCsv_(targetSheet.getDataRange().getValues());

  // CSVとしてレスポンスを返す
  return ContentService.createTextOutput(csvString)
    .setMimeType(ContentService.MimeType.CSV);
}
```

### 2. 定期実行によるデータ取得の自動化

GASの「トリガー」機能を利用し、データ更新日に合わせてスクリプトを自動実行しています。

```javascript
// 毎週木曜日 18:00 に実行
ScriptApp.newTrigger('main')
  .timeBased()
  .onWeekDay(ScriptApp.WeekDay.THURSDAY)
  .atHour(18)
  .create();
```

また、元データの更新ページから正規表現を使って最新の「年」と「週」を特定し、動的にダウンロードURLを生成するロジックを実装することで、メンテナンスフリーな運用を目指しました。

### 3. Chart.js と SVG地図の連携

フロントエンドでは、日本地図のSVGを用意し、各都道府県の `path` 要素に対して、データの値（定点当たり報告数）に応じた色を動的に設定しています。

*   **インフルエンザ**: 30.0以上で赤（警報）、10.0以上でオレンジ（注意報）
*   **COVID-19**: 10.0以上でオレンジ（注意報相当）

地図上の県をクリックすると、表示モードを切り替えて `Chart.js` でその県の週間推移グラフを描画します。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/4135758/b9ddb382-ae30-42e2-93aa-e2a3dd0da5e4.png)

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/4135758/cf6b0640-a78a-4ad4-b3e7-666af48b5eca.png)

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/4135758/ec3417d2-0e99-4cc5-a363-9fd68c5ef21e.png)

## こだわりポイント

*   **比較しやすいグラフ表現**:
    *   **Y軸の統一**: 都道府県ごとのグラフを表示する際、Y軸の最大値を全国最大値に合わせることで、地域間の流行レベルの差を直感的に比較できるようにしました。
    *   **過去データの重ね合わせ**: 当年のデータに加え、過去のデータをグレーアウトして重ねて表示。凡例をクリックすることで特定の年のデータを強調表示できるインタラクティブな機能も実装しました。
*   **インタラクティブなUI**: 地図からグラフへの遷移をスムーズにし、ユーザーがストレスなく詳細情報を掘り下げられるようにしました。
*   **アーカイブ機能**: 単に最新データを表示するだけでなく、取得したデータをGoogleドライブに保存していくことで、将来的な過去データ分析にも対応できるようにしました。
*   **エラーハンドリング**: スクレイピングやデータ取得は相手先サイトの構成変更などで失敗する可能性があるため、リトライ処理やログ出力を実装しています。

## まとめ

GASとGoogleスプレッドシートを組み合わせることで、サーバー代をかけずに実用的なデータ可視化アプリを作ることができました。

今回の開発における総コード行数は、HTML/CSS/JavaScript/GASを合わせて **約8,900行** に達しました。
4ヶ月前まではプログラミング未経験だった私がここまで作り上げることができたのは、**生成AIによるコーディング支援** があったからこそです。
非エンジニアであっても、アイデアとAIの力を組み合わせれば、現場の課題を解決する実用的なアプリケーションを自分の手で作り出せる時代になったと実感しています。

オープンデータには面白いものがたくさんあるので、皆さんもぜひGASで遊んでみてください！

---

## 【Kusuri Compass】のご紹介

今回の感染症動向アプリのように、私は薬剤師の業務をサポートするツールをいくつか開発しています。
それらをまとめたポータルサイト **「Kusuri Compass」** も公開していますので、もしよろしければ覗いてみてください。

**Kusuri Compass**
https://nekoneko0404.github.io/search-for-medicine-test02/

---

**参考**
*   国立感染症研究所 感染症発生動向調査 (IDWR)
*   Chart.js Documentation
*   Google Apps Script Reference
