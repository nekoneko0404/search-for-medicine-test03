# 【個人開発】感染症可視化アプリを「爆速」にアップデートした話 (GAS + Chart.js)

以前、薬剤師としての業務改善のために「感染症の流行状況を可視化するWebアプリ」を開発し、その仕組みを記事にしました。
（前回の記事：[【個人開発】薬剤師が感染症動向を可視化するWebアプリを作った話 (GAS + Chart.js)](https://note.com/nekoneko0404/n/nad0eb78a6386)）

今回は、このアプリに大型アップデートを実施しました。
こだわったのは**「網羅性」**と**「爆速体験」**です。

## 今回のアップデート内容

1.  **5類感染症すべてに対応**：インフルエンザ・コロナだけでなく、手足口病やマイコプラズマ肺炎なども網羅。
2.  **2018年からの過去データに対応**：過去の流行と比較して「今年は早い？多い？」が一目でわかるように。
3.  **データ先読み機能で「爆速」表示**：メニュー画面での“待ち時間”を利用し、アプリを開いた瞬間にはロードが完了している状態を実現。

---

## 1. 5類感染症すべてに対応

これまでは「インフルエンザ」「COVID-19」「急性呼吸器感染症 (ARI)」の3つに絞って表示していましたが、現場では他の感染症の動向も重要です。
例えば、子供の間で流行する「手足口病」や「ヘルパンギーナ」、最近ニュースでも話題になった「マイコプラズマ肺炎」など、**5類定点把握疾患**と呼ばれる主要な感染症すべて（約20種類）に対応しました。

### 実装の工夫
画面がごちゃごちゃしないよう、メイン画面はこれまで通り「主要3疾患」にフォーカスし、右上の「その他の感染症」ボタンから一覧ビューに切り替えるUIにしました。
一覧ビューでは、多数のグラフをタイル状に並べることで、全国的な流行トレンドを俯瞰できるようにしています。

## 2. 2018年からの過去データに対応

「今は流行っているのか？」を判断するには、過去との比較が不可欠です。
そこで、**2018年から現在までの週次データ**をアーカイブし、グラフに重ねて表示できるようにしました。

*   **赤線**: 今年 (2025年)
*   **水色**: 昨年 (2024年)
*   **グレー**: それ以前 (2023年〜2018年)

これにより、「例年より立ち上がりが早い」「昨年ほどの規模ではない」といった分析が直感的に行えるようになりました。
グラフの凡例（年）をクリックすると、その年のデータをハイライトするインタラクティブな機能もChart.jsで実装しています。

## 3. メニューページにデータ先読み機能を搭載し、体感速度を爆速に

今回一番こだわったのがここです。
このアプリはGAS (Google Apps Script) をバックエンドにしているため、どうしても初回アクセス時のデータ取得（CSVダウンロード＆パース）に数秒のラグが発生してしまいます。
「見たいときにすぐ見れない」はツールとして致命的です。

そこで、**「機能選択メニュー」を開いている間に、裏側でデータを先読み（プリフェッチ）する**仕組みを導入しました。

### 爆速化の仕組み (Technical Tips)

1.  **`requestIdleCallback` の活用**:
    ユーザーがメニュー画面を開いたとき、メインスレッドの処理が落ち着いたタイミング（アイドル時）を見計らって、裏側で感染症データの `fetch` を開始します。これにより、メニュー操作の快適性を損なわずにデータを取得できます。

    ```
javascript
    // メニュー画面 (index.js) での処理イメージ
    if ('requestIdleCallback' in window) {
        requestIdleCallback(() => startPrefetch(), { timeout: 5000 });
    } else {
        setTimeout(startPrefetch, 3000);
    }
    ```

2.  **`LocalForage` によるキャッシュ共有**:
    取得したデータはブラウザの `IndexedDB` (LocalForageラッパーを使用) に保存します。
    アプリ本体のページ (`infection-surveillance-app/index.html`) に遷移した際、まずはこのローカルキャッシュを確認し、データがあれば即座に描画を開始します。

    ```
    javascript
    // DBインスタンスを共有設定
    const infectionStore = localforage.createInstance({
        name: 'KusuriCompassDB',
        storeName: 'infection_surveillance_store'
    });
    ```

この実装により、ユーザーがメニューから「全国感染状況」アイコンをクリックした瞬間、**ロード待ち時間ほぼゼロ**で地図とグラフが表示されるようになりました。まさに「爆速」です。

---

## まとめ

今回のアップデートで、単なる「可視化ツール」から、実業務での分析にも耐えうる「サーベイランスシステム」へと進化しました。
特にデータ先読みによるUX改善は、GASバックエンドの弱点（応答速度）をカバーする有効な手段だと感じています。

**Kusuri Compass** (ポータルサイト)
[https://nekoneko0404.github.io/search-for-medicine-test02/](https://nekoneko0404.github.io/search-for-medicine-test02/)
※ 本記事の感染症アプリもここからアクセスできます。

もし興味があれば、ぜひ触ってみてください。