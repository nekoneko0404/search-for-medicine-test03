# Kusuri Compass 仕様書

## 1. 概要

本仕様書は、医薬品情報検索システム「Kusuri Compass」の機能、仕様、および技術詳細について記述する。

このシステムは、主に以下の機能を提供するWebアプリケーションポータルである。

1.  **医薬品出荷状況検索:** 医薬品の供給状況をリアルタイムで検索・表示する。
2.  **薬局ヒヤリ・ハット事例検索:** 医薬品に関連するヒヤリ・ハット事例を検索・閲覧する。
3.  **全国感染状況:** 全国の感染症発生動向を地図とグラフで可視化する。
4.  **花粉飛散リアルタイム監視:** 全国の花粉飛散状況をリアルタイムで可視化する。
5.  **ぱっくんスタンプ:** お子様の服薬を支援するスタンプカードアプリ。
6.  **おくすりぱっくん:** 小児用医薬品の飲み合わせ検索（外部連携）。
7.  **代替薬ナビゲーター:** 生成AIによる代替薬提案（外部連携）。

これらの機能は、トップページ (`index.html`) のメニューからアクセスできる。

## 2. プロジェクト構成

### 2.1. 主要ディレクトリ・ファイル

| ファイル/ディレクトリ                  | 説明                                                                                             |
| -------------------------------------- | ------------------------------------------------------------------------------------------------ |
| `index.html`                           | アプリケーションのメインメニューページ。                                                         |
| `search.html`                          | 医薬品出荷状況検索ページのUI。                                                                   |
| `js/main.js`                           | `search.html` の主要なロジック。データの取得、フィルタリング、描画を担う。                       |
| `js/data.js`                           | `main.js` から利用されるデータ管理モジュール。Google Sheetsからのデータ取得とキャッシュを担当。  |
| `js/ui.js`                             | `main.js` で利用されるUIコンポーネント生成モジュール。                                           |
| `js/utils.js`                          | 汎用的なユーティリティ関数（文字列正規化など）。                                                 |
| `hiyari_app/`                          | 薬局ヒヤリ・ハット事例検索機能の関連ファイルを格納。                                             |
| `infection-surveillance-app/`          | 全国感染状況可視化機能の関連ファイルを格納。                                                     |
| `pollen-app/`                          | 花粉飛散リアルタイム監視機能の関連ファイルを格納。                                               |
| `Okusuri_pakkun/`                      | ぱっくんスタンプ（服薬支援スタンプカード）の関連ファイルを格納。                                 |
| `drug-classification/`                 | 薬効分類検索機能（代替薬検索の補助）の関連ファイルを格納。                                       |
| `update/`                              | 出荷状況更新情報検索機能の関連ファイルを格納。                                                   |

### 2.2. 利用ライブラリ

-   **Tailwind CSS:** UIフレームワークとして利用。
-   **Chart.js:** グラフ描画に利用。
-   **localForage:** IndexedDBをラップし、クライアントサイドでのデータキャッシュに利用。
-   **marked.js, DOMPurify:** 更新履歴（Markdown）の表示に利用。
-   **xlsx.js:** 医薬品メーカーの公式サイト情報（Excelファイル）の解析に利用。
-   **Leaflet.js:** 地図表示（花粉アプリ）に利用。

## 3. 機能仕様詳細

### 3.1. 医薬品出荷状況検索 (`search.html`)

#### 3.1.1. 機能概要

Google Sheetsをデータソースとして、医薬品の出荷状況を検索・表示する。

#### 3.1.2. データソース

-   **メインデータ:** Google Sheets
    -   ID: `1ZyjtfiRjGoV9xHSA5Go4rJZr281gqfMFW883Y7s9mQU`
    -   Google Visualization API (`gviz/tq?tqx=out:csv`) を介してCSV形式で取得。
-   **メーカー情報:** Google Sheets
    -   ID: `1lTHHbUj6ySAgtum8zJrHjWAxYnbOO9r8H8Cnu-Y0TnA`
    -   Excel形式 (`.xlsx`) で取得し、メーカー公式サイトのURLを解析。

#### 3.1.3. キャッシュ戦略

-   `localforage` を使用し、メインデータをクライアントのIndexedDBに1時間キャッシュする。
-   キャッシュが存在し有効な場合はキャッシュから、それ以外はネットワークからデータを取得する。
-   手動リロードボタンによるキャッシュの強制クリアと再取得が可能。

#### 3.1.4. 検索機能

-   **検索フィールド:** 医薬品名、成分名、規格・剤形・メーカー。
-   **検索ロジック:**
    -   スペース区切りによるAND検索。
    -   `-` (ハイフン) を接頭辞としたキーワードによる除外検索。
-   **フィルタリング:** 出荷状況（通常出荷, 限定出荷, 供給停止）のチェックボックスによる絞り込み。

#### 3.1.5. 表示機能

-   検索結果をテーブル形式で表示（品名、成分名、出荷状況など）。
    -   更新があったセルは赤字でハイライトされる。
    -   供給状況の変動（改善/悪化）が矢印（⤴️/⤵️）で示される。
-   品名、成分名、出荷状況の列でソートが可能。
-   医薬品名にはドロップダウンメニューが表示され、以下の追加アクションが可能。
    -   代替薬検索（同一成分で再検索）
    -   公式サイトへのリンク（メーカー情報から取得）
    -   ヒヤリハット事例検索 (`hiyari_app` へ遷移)
    -   代替薬ナビゲーター (`drug-navigator` へ遷移)

---

### 3.2. 薬局ヒヤリ・ハット事例検索 (`hiyari_app/`)

#### 3.2.1. 機能概要

公益財団法人日本医療機能評価機構が提供する薬局ヒヤリ・ハット事例のデータベースを検索・閲覧する。

#### 3.2.2. データソース

-   **API:** `https://www.yakkyoku-hiyari.jcqhc.or.jp/phsearch/SearchNewReportApi.action` (直接アクセス)
    -   CORSポリシーを回避するためのプロキシサーバーを経由。
    -   バックエンドで日本医療機能評価機構のAPIを呼び出し、結果をXML形式で返す。

#### 3.2.3. 検索機能

-   **検索フィールド:** 医薬品名・成分名、絞り込みキーワード。
-   **APIリクエスト:**
    -   キーワードを元にAPIリクエストURLを構築。
    -   医薬品名・成分名でのOR検索や、絞り込みキーワードとのAND検索を動的に行う。

#### 3.2.4. 表示機能

-   検索結果をカード形式でグリッド表示する。
-   各カードには、事例概要、発生年月、要因、改善策などが表示される。
-   医薬品検索画面から遷移した場合、URLのクエリパラメータ (`drugName`) を受け取り、自動で検索を実行する。

---

### 3.3. 全国感染状況 (`infection-surveillance-app/`)

#### 3.3.1. 機能概要

国立感染症研究所の感染症発生動向調査（IDWR）データを元に、全国の感染状況を地図とグラフで可視化する。

#### 3.3.2. データソース

-   **API:** Google Apps Script (GAS) で構築されたAPI。
    -   バックエンドでIDWRのデータを取得・整形し、JSON形式で返す。

#### 3.3.3. 表示機能

-   **サマリーカード:** 主要3疾患（インフルエンザ, COVID-19, ARI）の全国の定点当たり報告数を表示。
-   **メインビュー:**
    -   **日本地図:** 地域ブロックごとの流行状況を色分け表示。クリックで詳細パネルへ。
    -   **地域詳細パネル:** 都道府県別の報告数を棒グラフ表示。
    -   **全国トレンドグラフ:** 上位10都道府県を表示。
-   **都道府県週次推移ビュー:** 複数年にわたる週次推移を折れ線グラフで比較表示。
-   **その他の感染症ビュー:** 主要3疾患以外の感染症について、週次推移グラフを表示。

---

### 3.4. 花粉飛散リアルタイム監視 (`pollen-app/`)

#### 3.4.1. 機能概要

ウェザーニューズ社の「ポールンロボ」観測データを活用し、日本全国の花粉飛散状況をリアルタイムに可視化する。

#### 3.4.2. 詳細仕様

詳細は `pollen-app/SPECIFICATION.md` を参照のこと。

#### 3.4.3. 主な機能

-   **リアルタイムマップ**: 全国各地の花粉飛散量を地図上にマーカー表示。
-   **5段階色分け**: 飛散量に応じた直感的な色分け表示（紫〜白）。
-   **気象データ連携**: Open-Meteo APIを利用し、気温・降水量・風速を表示。
-   **トレンド分析**: 過去28日間の花粉飛散数と気象条件の推移をグラフで確認可能。

---

### 3.5. ぱっくんスタンプ (`Okusuri_pakkun/`)

#### 3.5.1. 機能概要

お子様が楽しく服薬を続けられるようにサポートする、スタンプカード形式のWebアプリケーション。

#### 3.5.2. 詳細仕様

詳細は `Okusuri_pakkun/SPECIFICATION.md` を参照のこと。

#### 3.5.3. 主な機能

-   **スタンプ機能**: 服薬ごとにスタンプを押すことで達成感を得られる。
-   **キャラクター演出**: スタンプ時にキャラクターが登場し、褒めてくれる。
-   **表彰状**: スタンプが貯まると表彰状が表示され、印刷も可能。
-   **設定**: 服用回数や期間をカスタマイズ可能。

---

### 3.6. 外部連携機能

#### 3.6.1. 代替薬ナビゲーター

-   **概要**: 外部サービス「drug-navigator」と連携し、生成AIを用いた代替薬検索機能を提供する。
-   **連携**: メニューおよび検索結果から遷移可能。検索語句をクエリパラメータとして渡す。

#### 3.6.2. おくすりぱっくん (飲み合わせ検索)

-   **概要**: 外部サービス「okusuri-pakkun-app」と連携し、小児用医薬品の飲み合わせ検索機能を提供する。
-   **連携**: メニューから遷移可能。


