# Kusuri Compass 仕様書

## 1. 概要

本仕様書は、医薬品情報検索システム「Kusuri Compass」 (`search-for-medicine-test03`) の機能、仕様、および技術詳細について記述する。

このシステムは、主に以下の3つのコア機能を提供するWebアプリケーションである。

1.  **医薬品出荷状況検索:** 医薬品の供給状況をリアルタイムで検索・表示する。
2.  **薬局ヒヤリ・ハット事例検索:** 医薬品に関連するヒヤリ・ハット事例を検索・閲覧する。
3.  **全国感染状況:** 全国の感染症発生動向を地図とグラフで可視化する。

これらの機能は、トップページ (`index.html`) のメニューからアクセスできる。

## 2. プロジェクト構成

### 2.1. 主要ディレクトリ・ファイル

| ファイル/ディレクトリ                  | 説明                                                                                             |
| -------------------------------------- | ------------------------------------------------------------------------------------------------ |
| `index.html`                           | アプリケーションのメインメニューページ。                                                         |
| `search.html`                          | 医薬品出荷状況検索ページのUI。                                                                   |
| `js/main.js`                           | `search.html` の主要なロジック。データの取得、フィルタリング、描画を担う。                       |
| `js/data.js`                           | `main.js` から利用されるデータ管理モジュール。Google Sheetsからのデータ取得とキャッシュを担当。  |
| `js/ui.js`                             | `main.js` で利用されるUIコンポーネント生成モジュール。                                           |
| `js/utils.js`                          | 汎用的なユーティリティ関数（文字列正規化など）。                                                 |
| `hiyari_app/`                          | 薬局ヒヤリ・ハット事例検索機能の関連ファイルを格納。                                             |
| `hiyari_app/index.html`                | ヒヤリハット検索ページのUI。                                                                     |
| `hiyari_app/js/main.js`                | ヒヤリハット検索機能の主要ロジック。プロキシ経由でのAPI通信と結果描画を担う。                    |
| `infection-surveillance-app/`          | 全国感染状況可視化機能の関連ファイルを格納。                                                     |
| `infection-surveillance-app/index.html`| 感染状況可視化ページのUI。                                                                       |
| `infection-surveillance-app/main.js`   | 感染状況可視化機能の主要ロジック。Google Apps Script経由でのデータ取得、処理、グラフ描画を担う。 |
| `infection-surveillance-app/map.js`    | 日本地図（ブロックマップ）のSVG描画とインタラクションを担当。                                    |

### 2.2. 利用ライブラリ

-   **Tailwind CSS:** UIフレームワークとして利用。
-   **Chart.js:** 感染症サーベイランス機能におけるグラフ描画に利用。
-   **localForage:** IndexedDBをラップし、クライアントサイドでのデータキャッシュに利用。
-   **marked.js, DOMPurify:** 更新履歴（Markdown）の表示に利用。
-   **xlsx.js:** 医薬品メーカーの公式サイト情報（Excelファイル）の解析に利用。

## 3. 機能仕様詳細

### 3.1. 医薬品出荷状況検索 (`search.html`)

#### 3.1.1. 機能概要

Google Sheetsをデータソースとして、医薬品の出荷状況を検索・表示する。

#### 3.1.2. データソース

-   **メインデータ:** Google Sheets
    -   ID: `1ZyjtfiRjGoV9xHSA5Go4rJZr281gqfMFW883Y7s9mQU`
    -   Google Visualization API (`gviz/tq?tqx=out:csv`) を介してCSV形式で取得。
-   **メーカー情報:** Google Sheets
    -   ID: `1lTHHbUj6ySAgtum8zJrHjWAxYnbOO9r8H8Cnu-Y0TnA`
    -   Excel形式 (`.xlsx`) で取得し、メーカー公式サイトのURLを解析。

#### 3.1.3. キャッシュ戦略

-   `localforage` を使用し、メインデータをクライアントのIndexedDBに1時間キャッシュする。
-   キャッシュが存在し有効な場合はキャッシュから、それ以外はネットワークからデータを取得する。
-   手動リロードボタンによるキャッシュの強制クリアと再取得が可能。

#### 3.1.4. 検索機能

-   **検索フィールド:** 医薬品名、成分名、規格・剤形・メーカー。
-   **検索ロジック:**
    -   スペース区切りによるAND検索。
    -   `-` (ハイフン) を接頭辞としたキーワードによる除外検索。
-   **フィルタリング:** 出荷状況（通常出荷, 限定出荷, 供給停止）のチェックボックスによる絞り込み。

#### 3.1.5. 表示機能

-   検索結果をテーブル形式で表示（品名、成分名、出荷状況など）。
    -   更新があったセルは赤字でハイライトされる。
    -   供給状況の変動（改善/悪化）が矢印（⤴️/⤵️）で示される。
-   品名、成分名、出荷状況の列でソートが可能。
-   医薬品名にはドロップダウンメニューが表示され、以下の追加アクションが可能。
    -   代替薬検索（同一成分で再検索）
    -   公式サイトへのリンク（メーカー情報から取得）
    -   ヒヤリハット事例検索 (`hiyari_app` へ遷移)

---

### 3.2. 薬局ヒヤリ・ハット事例検索 (`hiyari_app/`)

#### 3.2.1. 機能概要

公益財団法人日本医療機能評価機構が提供する薬局ヒヤリ・ハット事例のデータベースを検索・閲覧する。

#### 3.2.2. データソース

-   **API:** `https://hiyari-proxy-708146219355.asia-east1.run.app/proxy`
    -   CORSポリシーを回避するためのプロキシサーバー。
    -   バックエンドで日本医療機能評価機構のAPIを呼び出し、結果をXML形式で返す。

#### 3.2.3. 検索機能

-   **検索フィールド:** 医薬品名・成分名、絞り込みキーワード。
-   **APIリクエスト:**
    -   キーワードを元にAPIリクエストURLを構築。
    -   医薬品名・成分名でのOR検索や、絞り込みキーワードとのAND検索を動的に行う。

#### 3.2.4. 表示機能

-   検索結果をカード形式でグリッド表示する。
-   各カードには、事例概要、発生年月、要因、改善策などが表示される。
-   APIから返却されるコード値は、`DATSUMMARY_MAP`などのマッピングオブジェクトを介して日本語のテキストに変換される。
-   医薬品検索画面から遷移した場合、URLのクエリパラメータ (`drugName`) を受け取り、自動で検索を実行する。
-   「表示順をシャッフル」機能により、検索結果をランダムに並べ替えることができる。

---

### 3.3. 全国感染状況 (`infection-surveillance-app/`)

#### 3.3.1. 機能概要

国立感染症研究所の感染症発生動向調査（IDWR）データを元に、全国の感染状況を地図とグラフで可視化する。

#### 3.3.2. データソース

-   **API:** `https://script.google.com/macros/s/AKfycby8wh0NMuPtEOgLVHXfc0jzNqlOENuOgCwQmYYzMSZCKTvhSDiJpZkAyJxntGISTGOmbQ/exec`
    -   Google Apps Script (GAS) で構築されたAPI。
    -   バックエンドでIDWRのデータを取得・整形し、JSON形式で返す。
    -   リクエストタイプ (`?type=latest`, `?type=history`, `?type=combined`) に応じて異なるデータを返す。

#### 3.3.3. キャッシュ戦略

-   `localforage` を使用し、`combined`（最新＋過去）データを30分キャッシュする。
-   手動リロードボタンによるキャッシュの強制クリアと再取得が可能。

#### 3.3.4. 表示機能

-   **サマリーカード:** 主要3疾患（インフルエンザ, COVID-19, ARI）の全国の定点当たり報告数を表示。
-   **メインビュー:**
    -   **日本地図:**
        -   日本を8つの地域ブロックに分けたタイルマップをSVGで動的に描画。
        -   各ブロックは、属する都道府県の報告数の平均値に基づき、警報レベルに応じて色分けされる (`getColorForValue`関数)。
    -   **地域詳細パネル:**
        -   地図ブロックをクリックすると、右パネルに地域内の都道府県別報告数を棒グラフ形式で表示。
        -   都道府県名をクリックすると、その都道府県の週次推移グラフビューにドリルダウンする。
    -   **全国トレンドグラフ:**
        -   報告数の多い上位10都道府県を棒グラフで表示。
-   **都道府県週次推移ビュー:**
    -   複数年にわたる週次推移を折れ線グラフで比較表示。
-   **その他の感染症ビュー:**
    -   主要3疾患以外の感染症について、週次推移グラフを一覧表示。
    -   都道府県セレクターで表示地域を絞り込み可能。

#### 3.3.5. モジュール連携

-   `main.js` がデータ処理と全体制御、`map.js` が地図描画とインタラクションを担当。
-   両者はグローバルスコープに公開された関数 (`window.updateDetailPanel`, `window.showPrefectureChart`など) を通じて相互に連携し、ドリルダウンなどのインタラクティブな機能を実現している。
