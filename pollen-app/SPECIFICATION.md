# 花粉飛散リアルタイム監視 (Pollen Radar) 仕様書

## 1. 概要

「花粉飛散リアルタイム監視 (Pollen Radar)」は、日本全国の花粉飛散状況をリアルタイムに可視化するWebアプリケーションである。ウェザーニューズ社の「ポールンロボ」観測データを活用し、地図上で直感的に花粉の飛散量を確認できる。また、気象データ（天気、気温、降水量、風）を地図上に重ねて表示することで、花粉飛散と気象条件の相関を視覚的に把握できる。

## 2. システム構成

### 2.1. 技術スタック

*   **フロントエンド**: HTML5, CSS3, JavaScript (Vanilla ES6+)
*   **地図ライブラリ**: Leaflet.js (v1.9.4)
*   **グラフ描画**: Chart.js
*   **アイコン**: Font Awesome
*   **フォント**: Google Fonts (Inter, Noto Sans JP)
*   **アナリティクス**: Google Analytics (GA4)
*   **SEO**: Meta tags (description, keywords, canonical, robots)

### 2.2. データソース

1.  **花粉データ**: ウェザーニューズ (Weathernews) Open Data API
    *   エンドポイント: `https://wxtech.weathernews.com/opendata/v1/pollen`
    *   データ形式: CSV
    *   更新頻度: リアルタイム (1時間ごと)
2.  **気象データ**: Open-Meteo API
    *   エンドポイント: `https://api.open-meteo.com/v1/forecast` (現在/予報), `https://archive-api.open-meteo.com/v1/archive` (過去)
    *   取得項目: 天気コード, 気温 (2m), 降水量, 風速 (10m), 風向 (10m)
3.  **地図タイル**: 国土地理院 (GSI) 地理院タイル
    *   標準地図: 淡色地図 (`xyz/pale`)
    *   地形図: 起伏地図 (`xyz/hillshademap`)

## 3. 機能仕様

### 3.1. 地図表示機能

*   **ベースマップ切り替え**:
    *   **通常地図**: 国土地理院の淡色地図を使用。視認性を高め、マーカーを目立たせる。
    *   **立体地形図**: 国土地理院の起伏地図を使用。地形による花粉飛散への影響を考慮する際に有用。
*   **ズームレベル制御**:
    *   `minZoom`: 2 (全国俯瞰)
    *   `maxZoom`: 12 (詳細地域)
    *   初期表示: ズームレベル 5, 中心座標 [36.2048, 138.2529] (日本列島中心)

### 3.2. 花粉マーカー表示 (LOD制御)

地図上の花粉マーカーは、パフォーマンスと視認性を最適化するために、ズームレベルに応じて動的に制御される (`updateVisibleMarkers`)。

*   **表示レベル (Level of Detail)**:
    *   **Zoom < 8**: 主要都市 (Level 1) のみ表示。
    *   **Zoom >= 8**: 中規模都市 (Level 2) を追加。
    *   **Zoom >= 10**: 全観測地点 (Level 3) を表示。
*   **表示数制限と優先順位**:
    *   **表示数制限と優先順位**:
        *   **距離ベースの密度制御**: 画面中心からの距離に応じて、ポイント間の最小距離を動的に調整する。
            *   中心部: 最小距離 40px (高密度)
            *   周辺部: 最小距離 150px (低密度)
            *   全国表示 (Zoom < 7): 最小距離を短縮 (中心 30px, 周辺 80px) し、表示数を増やす。
            *   最拡大時 (Zoom >= 12): 密度制御を無効化し、画面内の全地点を表示する。
        *   **優先順位**:
            1.  画面中心からの距離が近い順 (データ取得もこの順序で行われる)
*   **色分け (5段階)**:
    花粉飛散量に応じてマーカーの色を変化させる。当日データと過去データで閾値が異なる。
    (紫: 非常に多い, 赤: 多い, 黄: やや多い, 青: 少ない, 白: なし)
*   **ツールチップ**:
    *   `ZOOM_THRESHOLD` (11) 以上で、マーカー上に簡易グラフ（ツールチップ）を常時表示する。
    *   グラフは視覚的アクセントとして右に **5度** 傾けて表示される。

### 3.3. 天気情報表示 (Weather Layer)

「天気表示」ボタンでトグル切り替えが可能。

*   **天気マーカー**:
    *   地図上に天気アイコン（晴れ、曇り、雨、雪など）と気温を表示。
    *   **優先表示**: 主要都市（東京、大阪、名古屋、札幌、福岡、仙台、広島）を最優先で表示し、重なり (`minDistancePx: 120`) を回避しつつ全国に分散表示する。
*   **風アニメーション (Wind Animation)**:
    *   Canvasレイヤーを使用し、風の流れをパーティクルアニメーションで表現。
    *   風速と風向データに基づき、粒子の移動速度と方向を計算（風速が速いほど粒子が速く移動し、軌跡が長く見える）。
    *   ズームレベルに応じて粒子の軌跡の長さ (`scale`) や不透明度 (`dynamicOpacity`) を調整し、視認性を確保。

### 3.4. 詳細情報表示 (ポップアップ)

花粉マーカーをクリックするとポップアップが表示される。

*   **基本情報**: 都市名、日付。
*   **時間別推移グラフ**: 当該日の1時間ごとの花粉飛散数を棒グラフで表示。
*   **気象情報**: Open-Meteoから取得した気温、降水量、風速・風向を表示。
*   **週間推移ボタン**: 「週間推移」ボタンをクリックすると、モーダルウィンドウで詳細トレンドを表示。

### 3.5. トレンド分析 (モーダル)

*   **28日間推移グラフ**:
    *   過去28日間のデータを複合グラフで表示。
    *   **花粉数**: 折れ線グラフ (青色)
    *   **最高気温**: 点線折れ線グラフ (オレンジ色)
    *   **降水量**: 棒グラフ (薄青色)
*   **目的**: 花粉飛散量と気象条件（気温上昇や降雨）の関係性を視覚的に分析できる。

### 3.6. UI/UX機能

*   **日付選択**:
    *   カレンダー (`input[type="date"]`) による任意日付選択。
    *   クイックボタン: 「今日」「昨日」「1週間前」「1年前」「2年前」「3年前」。
*   **トースト通知**:
    *   APIエラー（例: 429 Too Many Requests）発生時などに、画面下部に一時的なメッセージを表示。
*   **サイドパネル**:
    *   各種コントロールを集約。モバイル対応（自動折りたたみ）。
*   **十字マーク (Crosshair)**:
    *   画面中央に十字マークを表示し、ポイント密度の中心を可視化。

## 4. 技術詳細

### 4.1. キャッシュ戦略

*   **花粉データ**:
    *   APIレスポンスをメモリ内 (`state.cache`) に保存。有効期限: 10分。
*   **天気データ**:
    *   `weatherCache` に保存。有効期限: 10分。
    *   キー: `cityCode-date`。

### 4.2. セキュリティ対策

*   **Content Security Policy (CSP)**:
    *   厳格なCSPを設定し、許可されたドメイン以外からのリソース読み込みをブロック。
*   **HTMLサニタイズ**:
    *   `sanitizeHTML` 関数を使用し、XSS脆弱性を防止。

### 4.3. ファイル構成

*   `index.html`: アプリケーションのメイン構造。
*   `style.css`: スタイル定義。
*   `script.js`: 花粉データ取得、地図制御、ポップアップ、トレンドグラフ描画。
*   `weather.js`: 天気マーカー表示、風アニメーション、トースト通知ロジック。
*   `cities.js`: 観測地点定義データ (`CITIES` 配列)。

### 4.4. ライセンス・クレジット

本アプリケーションで使用しているデータおよびライブラリのライセンス要件に基づき、以下のクレジット表記を行う。

*   **Weathernews Inc.**: 花粉データ提供元として明記。
*   **Open-Meteo**: 天気データ提供元として、CC BY 4.0ライセンスに基づき "Weather data by Open-Meteo.com" の表記とリンクを設置。
*   **国土地理院**: 地図タイル出典として、利用規約に基づき「出典：国土地理院」の表記とリンクを設置。
